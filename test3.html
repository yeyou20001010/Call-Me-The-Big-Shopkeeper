<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&family=Varela+Round&display=swap" rel="stylesheet">
    <title>é«”åŠ›ç›£æ§ä¸­å¿ƒ</title>
    <style>
        :root {
            --highlight-pink: #FF9D6F; 
            --full-green: #02C874;     
            --morandi-bg: #FBFBF9;
            --tag-bg: #F0EFEB;
            --line-green: #06C755;
        }
        body { 
            font-family: 'Varela Round', 'Noto Sans TC', sans-serif;
            background-color: #EAE8E4; 
            color: #6D6875;
        }
        .card-standard { background-color: var(--morandi-bg); border: 1px solid #D7D3CC; }
        .card-full-highlight { 
            background-color: var(--morandi-bg) !important; 
            border: 4px solid var(--full-green) !important; 
            box-shadow: 0 4px 15px rgba(2, 200, 116, 0.15); 
        }
        .text-status-pink { color: var(--highlight-pink); } 
        .text-full-green { color: var(--full-green); }
        .tag-label { 
            background-color: var(--tag-bg); 
            color: #5E548E; 
            border: 1px solid #D7D3CC;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900;
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.8s ease-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        @keyframes blinker { 50% { opacity: 0.3; } }
        .animate-guide { animation: blinker 2s linear infinite; }
        
        /* ç·¨è¼¯æŒ‰éˆ•æ¨£å¼ */
        .fat-pencil-btn { 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            background: #EAE8E4;
            border-radius: 8px;
            transition: all 0.2s; 
            cursor: pointer;
            border: 1px solid #D7D3CC;
            color: #6D6875;
        }
        .fat-pencil-btn:hover { 
            transform: scale(1.1); 
            background: #FFF;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #FF9D6F;
        }

        /* æ‹–æ›³ç‹€æ…‹è¦–è¦ºåé¥‹ */
        .member-item.dragging {
            opacity: 0.2;
            transform: scale(0.95);
            border: 2px dashed #FF9D6F;
            background-color: #FFF5F0;
        }

        /* Switch æ¨£å¼ */
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #D7D3CC; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--line-green); }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col lg:flex-row justify-between items-center mb-10 bg-[#FBFBF9] p-8 rounded-[2rem] shadow-sm border border-[#D7D3CC] gap-6">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-[#6D6875] rounded-2xl flex items-center justify-center text-[#F4F2EE] text-3xl font-black shadow-inner">âš¡</div>
                <div>
                    <h2 class="text-3xl font-black text-[#5E548E] tracking-tight">é«”åŠ›ç›£æ§ä¸­å¿ƒ</h2>
                    <p class="text-xs font-bold text-[#8E9AAF] tracking-widest uppercase opacity-70">Stamina Real-time Monitor</p>
                </div>
            </div>
            
            <div class="flex flex-col lg:flex-row gap-3 items-center">
                <div class="flex items-center bg-[#F0EFEB] rounded-2xl p-1 border border-[#D7D3CC] w-full lg:w-auto">
                    <button onclick="changeSort(-1)" class="p-3 hover:bg-white rounded-xl transition text-[#8E9AAF] font-bold">â®</button>
                    <div class="px-4 min-w-[150px] text-center flex-1">
                        <p class="text-[10px] font-black text-[#A5A5A5] uppercase">æ’åºæ–¹å¼</p>
                        <span id="sortModeText" class="font-black text-sm text-[#6D6875]">æŒ‰æ´»å‹• (é è¨­)</span>
                    </div>
                    <button onclick="changeSort(1)" class="p-3 hover:bg-white rounded-xl transition text-[#8E9AAF] font-bold">â¯</button>
                </div>
                
                <div class="grid grid-cols-2 lg:flex gap-3 w-full lg:w-auto">
                    <button onclick="openNotifyModal()" class="bg-[#06C755] text-white px-4 py-4 rounded-2xl font-black shadow-sm hover:bg-[#05B34C] transition-all active:scale-95 text-sm whitespace-nowrap">ğŸ”” é€šçŸ¥è¨­å®š</button>
                    <button onclick="openManageModal()" class="bg-[#B8B0A5] text-white px-4 py-4 rounded-2xl font-black shadow-sm hover:bg-[#A69D92] transition-all active:scale-95 text-sm whitespace-nowrap">ğŸ‘¥ åå–®ç®¡ç†</button>
                    <button onclick="askClearAll()" class="bg-[#AF7A7D] text-white px-4 py-4 rounded-2xl font-black shadow-sm hover:bg-[#9B6B6E] transition-all active:scale-95 text-sm whitespace-nowrap">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º</button>
                    <button onclick="window.location.replace('portal.html')" class="bg-[#6D6875] text-white px-4 py-4 rounded-2xl font-black shadow-sm hover:bg-[#5A5562] transition-all active:scale-95 text-sm whitespace-nowrap">è¿”å›é¸å–®</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <div class="xl:col-span-1">
                <div class="bg-[#FBFBF9] p-8 rounded-[2.5rem] shadow-sm border border-[#D7D3CC] sticky top-10">
                    <h3 class="text-lg font-black text-[#6D6875] mb-6 border-b border-[#F0EFEB] pb-4">ğŸ“… æ´»å‹•é¸æ“‡</h3>
                    <select id="activitySelect" class="w-full p-4 bg-white rounded-2xl font-black text-[#8E9AAF] border border-[#D7D3CC] mb-4 outline-none focus:ring-2 focus:ring-[#B8B0A5] transition-all cursor-pointer"></select>
                    <div class="bg-[#F4F2EE] p-5 rounded-2xl space-y-2 text-sm font-bold">
                        <div class="flex justify-between"><span class="text-[#A5A5A5]">æ¢å¾©é€Ÿç‡</span><span id="rateDetail" class="text-[#6D6875]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#A5A5A5]">é«”åŠ›ä¸Šé™</span><span id="maxDetail" class="text-[#6D6875]">--</span></div>
                    </div>
                    <button onclick="openBatchModal()" class="w-full mt-8 bg-[#8E9AAF] text-white py-5 rounded-[2rem] text-lg font-black shadow-md hover:bg-[#7D7684] transition-all active:scale-95">ğŸš€ æ‰¹é‡åŠ å…¥ç›£æ¸¬</button>
                </div>
            </div>

            <div class="xl:col-span-3">
                <div id="monitorGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                <div id="emptyDisplay" class="hidden text-center py-40 bg-[#FBFBF9] rounded-[3rem] border-4 border-dashed border-[#D7D3CC]">
                    <div class="text-6xl mb-6 opacity-20">ğŸ’¤</div>
                    <p class="text-[#D7D3CC] font-black text-2xl">ç›®å‰ç„¡é€²è¡Œä¸­çš„ç›£æ¸¬é …ç›®</p>
                    <p class="text-[#D7D3CC] font-bold mt-2">è«‹å¾å·¦å´é¸æ“‡æ´»å‹•ä¸¦åŠ å…¥äººç‰©</p>
                </div>
            </div>
        </div>
    </div>

    <div id="notifyModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-[110] backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl relative border border-[#D7D3CC]">
            <h3 class="text-xl font-black mb-2 text-[#5E548E]">LINE å€‹äººé€šçŸ¥è¨­å®š</h3>
            <p class="text-[10px] font-bold text-[#8E9AAF] mb-6 uppercase tracking-widest">Personalize Your Notifications</p>
            <div class="space-y-4">
                <div class="flex items-center justify-between bg-white p-5 rounded-3xl border border-[#D7D3CC]">
                    <span class="font-black text-[#6D6875]">é–‹å•Ÿ LINE æé†’</span>
                    <label class="switch"><input type="checkbox" id="lineNotifyToggle"><span class="slider"></span></label>
                </div>
                <div class="bg-white p-5 rounded-3xl border border-[#D7D3CC]">
                    <p class="text-[9px] font-black text-[#A5A5A5] mb-2 uppercase">æ‚¨çš„å€‹äººé€šçŸ¥ ID</p>
                    <input id="userIdInput" type="text" placeholder="è«‹è²¼ä¸Š U é–‹é ­çš„ ID..." class="w-full p-4 bg-[#F4F2EE] border border-[#D7D3CC] rounded-xl text-xs font-bold text-[#6D6875] outline-none mb-3">
                    <a href="https://lin.ee/P511ju5" target="_blank" class="block w-full text-center py-3 bg-[#F0EFEB] text-[#8E9AAF] rounded-xl text-[10px] font-black hover:bg-[#EAE8E4] transition-all">ğŸ’¬ é»æ­¤åŠ å…¥å¥½å‹å¾Œï¼Œé»æ“Šé¸å–®æˆ–è¼¸å…¥ã€ŒæŸ¥è©¢IDã€ä»¥ç²å–å€‹äººä»£ç¢¼</a>
                </div>
            </div>
            <button onclick="saveNotifySettings()" class="w-full mt-8 py-5 bg-[#06C755] text-white rounded-[1.5rem] font-black shadow-lg">å„²å­˜è¨­å®šä¸¦æ¸¬è©¦</button>
            <button onclick="closeModal('notifyModal')" class="w-full mt-3 py-2 text-[#A5A5A5] font-bold text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="customPromptModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-[120] backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl relative border border-[#D7D3CC]">
            <h3 id="promptTitle" class="text-xl font-black mb-4 text-[#5E548E]">æç¤º</h3>
            <p id="promptSub" class="text-sm font-bold text-[#8E9AAF] mb-4"></p>
            <input id="promptInput" type="text" class="w-full p-4 bg-white border border-[#D7D3CC] rounded-2xl font-bold mb-6 outline-none focus:ring-2 focus:ring-[#FF9D6F]">
            <div class="flex gap-3">
                <button onclick="closeModal('customPromptModal')" class="flex-1 py-4 bg-[#D7D3CC] text-white rounded-2xl font-black hover:bg-[#C2BEB6]">å–æ¶ˆ</button>
                <button id="promptConfirmBtn" class="flex-1 py-4 bg-[#FF9D6F] text-white rounded-2xl font-black hover:bg-[#E88D5F]">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="manageModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-2xl rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-10 shadow-2xl relative flex flex-col max-h-[90vh] border border-[#D7D3CC]">
            <button onclick="closeModal('manageModal')" class="absolute top-6 right-6 md:top-10 md:right-10 text-[#D7D3CC] text-3xl hover:text-[#6D6875]">âœ•</button>
            <h3 class="text-2xl font-black mb-6 text-[#5E548E]">åå–®èˆ‡ç¾¤çµ„ç®¡ç†</h3>
            <div class="flex flex-wrap gap-2 mb-8 bg-white p-2 rounded-2xl border border-[#D7D3CC]">
                <input id="newGroupName" type="text" placeholder="è¼¸å…¥æ–°ç¾¤çµ„åç¨±..." class="flex-1 min-w-[150px] bg-transparent p-4 outline-none font-bold">
                <button onclick="addGroup()" class="bg-[#8E9AAF] text-white px-6 md:px-8 py-3 rounded-xl font-black hover:bg-[#7D7684] transition-all active:scale-95 whitespace-nowrap">å»ºç«‹ç¾¤çµ„</button>
            </div>
            <div id="groupListArea" class="overflow-y-auto flex-1 space-y-6 pr-2"></div>
        </div>
    </div>

    <div id="batchModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative flex flex-col max-h-[90vh] border border-[#D7D3CC]">
            <button onclick="closeModal('batchModal')" class="absolute top-10 right-10 text-[#D7D3CC] text-3xl">âœ•</button>
            <h3 class="text-2xl font-black mb-2 text-[#5E548E]">æ‰¹é‡åŠ å…¥ç›£æ¸¬</h3>
            <p id="batchActName" class="text-sm font-bold text-[#8E9AAF] mb-4"></p>
            <div class="flex justify-end gap-3 mb-4">
                <button onclick="toggleAllBatch(true)" class="text-xs font-black text-indigo-500 bg-indigo-50 px-3 py-1 rounded-lg">å…¨é¸</button>
                <button onclick="toggleAllBatch(false)" class="text-xs font-black text-[#AF7A7D] bg-red-50 px-3 py-1 rounded-lg">å–æ¶ˆå…¨é¸</button>
            </div>
            <div id="batchInputList" class="overflow-y-auto flex-1 space-y-6 mb-8 pr-2"></div>
            <button onclick="submitBatch()" class="w-full bg-[#8E9AAF] text-white py-6 rounded-[2rem] text-xl font-black shadow-lg hover:bg-[#7D7684]">ç¢ºèªä¸¦é–‹å§‹ç›£æ¸¬</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸è¨­å®š ---
        const MY_GAS_URL = "https://script.google.com/macros/s/AKfycbxna2VNkReOpEGTZsYq1LhgAd6zr0YfMRk_ADDn-js-2l9029KV8hWBhj2oZjfmaXxxsA/exec";

        let activities = [];
        let db = JSON.parse(localStorage.getItem('stamina_v15_db')) || { groups: [{ id: 'default', name: 'æœªåˆ†é¡äººç‰©', members: [] }] };
        let monitors = JSON.parse(localStorage.getItem('stamina_v15_active')) || [];
        let sortMode = 0; 
        const sortTexts = ["æŒ‰æ´»å‹• (é è¨­)", "æŒ‰å›æ»¿æ™‚é•·", "æŒ‰ç¾¤çµ„åç¨±", "æŒ‰äººç‰©åç¨±"];
        let notifySettings = JSON.parse(localStorage.getItem('stamina_notify_cfg')) || { line: false, userId: "" };
        let notifiedSet = new Set();

        window.onload = function() {
            const gameData = JSON.parse(sessionStorage.getItem('gameData'));
            if(!gameData) return location.href = "index.html"; 
            activities = gameData.activities;
            const select = document.getElementById('activitySelect');
            activities.forEach((act, idx) => {
                const opt = document.createElement('option'); 
                opt.value = idx; opt.textContent = act.name;
                select.appendChild(opt);
            });
            select.onchange = () => {
                const act = activities[select.value];
                // ä¿®æ­£ï¼šå°‡æ­»æ¿çš„ / 1 é«” æ”¹ç‚ºæ ¹æ“šæ•¸æ“š act.regain é¡¯ç¤º
                document.getElementById('rateDetail').innerText = `${act.minPerStamina} åˆ†é˜ / ${act.regain || 1} é«”`;
                document.getElementById('maxDetail').innerText = `${act.maxStamina} é«”`;
            };
            select.dispatchEvent(new Event('change'));
            document.getElementById('lineNotifyToggle').checked = notifySettings.line;
            document.getElementById('userIdInput').value = notifySettings.userId || "";
            renderMonitoring();
            setInterval(renderMonitoring, 1000);
        };

        // --- é€šçŸ¥é‚è¼¯ ---
        function saveNotifySettings() {
            notifySettings.line = document.getElementById('lineNotifyToggle').checked;
            notifySettings.userId = document.getElementById('userIdInput').value.trim();
            localStorage.setItem('stamina_notify_cfg', JSON.stringify(notifySettings));
            closeModal('notifyModal');
            if (notifySettings.line && notifySettings.userId) sendLineMsg("âš¡ ç›£æ§ç³»çµ±é€£ç·šæˆåŠŸï¼");
        }
        async function sendLineMsg(msg) {
            if(!notifySettings.line || !notifySettings.userId || !MY_GAS_URL) return;
            try { await fetch(MY_GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ userId: notifySettings.userId, message: msg }) }); } catch (e) {}
        }
        function triggerFullNotification(charName, actName) { sendLineMsg(`âš¡ é«”åŠ›å›æ»¿ï¼š\nè§’è‰²ï¼š${charName}\næ´»å‹•ï¼š${actName}`); }

        // --- ä¸»ç›£æ§ä»‹é¢æ¸²æŸ“ ---
        function renderMonitoring() {
            const grid = document.getElementById('monitorGrid');
            if(monitors.length === 0) { grid.innerHTML = ""; document.getElementById('emptyDisplay').classList.remove('hidden'); return; }
            document.getElementById('emptyDisplay').classList.add('hidden');
