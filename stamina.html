<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&family=Varela+Round&display=swap" rel="stylesheet">
    <title>é«”åŠ›ç›£æ§ä¸­å¿ƒ</title>
    <style>
        :root {
            --highlight-pink: #FF9D6F; 
            --full-green: #02C874;     
            --morandi-bg: #FBFBF9;
            --tag-bg: #F0EFEB;
        }
        body { 
            font-family: 'Varela Round', 'Noto Sans TC', sans-serif;
            background-color: #EAE8E4; 
            color: #6D6875;
        }
        .card-standard { background-color: var(--morandi-bg); border: 1px solid #D7D3CC; }
        .card-full-highlight { 
            background-color: var(--morandi-bg) !important; 
            border: 4px solid var(--full-green) !important; 
            box-shadow: 0 4px 15px rgba(2, 200, 116, 0.15); 
        }
        .text-status-pink { color: var(--highlight-pink); } 
        .text-full-green { color: var(--full-green); }
        .tag-label { 
            background-color: var(--tag-bg); 
            color: #5E548E; 
            border: 1px solid #D7D3CC;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900;
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.8s ease-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        @keyframes blinker { 50% { opacity: 0.3; } }
        .animate-guide { animation: blinker 2s linear infinite; }
        
        .fat-pencil-btn { 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            background: #EAE8E4;
            border-radius: 8px;
            transition: all 0.2s; 
            cursor: pointer;
            border: 1px solid #D7D3CC;
            color: #6D6875;
        }
        .fat-pencil-btn:hover { 
            transform: scale(1.1); 
            background: #FFF;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #FF9D6F;
        }

        .member-item.dragging {
            opacity: 0.4;
            border: 2px dashed #FF9D6F;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col lg:flex-row justify-between items-center mb-10 bg-[#FBFBF9] p-8 rounded-[2rem] shadow-sm border border-[#D7D3CC] gap-6">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-[#6D6875] rounded-2xl flex items-center justify-center text-[#F4F2EE] text-3xl font-black shadow-inner">âš¡</div>
                <div>
                    <h2 class="text-3xl font-black text-[#5E548E] tracking-tight">é«”åŠ›ç›£æ§ä¸­å¿ƒ</h2>
                    <p class="text-xs font-bold text-[#8E9AAF] tracking-widest uppercase opacity-70">Stamina Real-time Monitor</p>
                </div>
            </div>
            
            <div class="flex gap-3 flex-wrap justify-center items-center">
                <div class="flex items-center bg-[#F0EFEB] rounded-2xl p-1 border border-[#D7D3CC]">
                    <button onclick="changeSort(-1)" class="p-3 hover:bg-white rounded-xl transition text-[#8E9AAF] font-bold">â®</button>
                    <div class="px-4 min-w-[150px] text-center">
                        <p class="text-[10px] font-black text-[#A5A5A5] uppercase">æ’åºæ–¹å¼</p>
                        <span id="sortModeText" class="font-black text-sm text-[#6D6875]">æŒ‰æ´»å‹• (é è¨­)</span>
                    </div>
                    <button onclick="changeSort(1)" class="p-3 hover:bg-white rounded-xl transition text-[#8E9AAF] font-bold">â¯</button>
                </div>
                <button onclick="openManageModal()" class="bg-[#B8B0A5] text-white px-6 py-4 rounded-2xl font-black shadow-sm hover:bg-[#A69D92] transition-all active:scale-95">ğŸ‘¥ åå–®ç®¡ç†</button>
                <button onclick="askClearAll()" class="bg-[#AF7A7D] text-white px-6 py-4 rounded-2xl font-black shadow-sm hover:bg-[#9B6B6E] transition-all active:scale-95">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º</button>
                <button onclick="window.location.replace('portal.html')" class="bg-[#6D6875] text-white px-6 py-4 rounded-2xl font-black shadow-sm hover:bg-[#5A5562] transition-all active:scale-95">è¿”å›é¸å–®</button>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <div class="xl:col-span-1">
                <div class="bg-[#FBFBF9] p-8 rounded-[2.5rem] shadow-sm border border-[#D7D3CC] sticky top-10">
                    <h3 class="text-lg font-black text-[#6D6875] mb-6 border-b border-[#F0EFEB] pb-4">ğŸ“… æ´»å‹•é¸æ“‡</h3>
                    <select id="activitySelect" class="w-full p-4 bg-white rounded-2xl font-black text-[#8E9AAF] border border-[#D7D3CC] mb-4 outline-none focus:ring-2 focus:ring-[#B8B0A5] transition-all cursor-pointer"></select>
                    <div class="bg-[#F4F2EE] p-5 rounded-2xl space-y-2 text-sm font-bold">
                        <div class="flex justify-between"><span class="text-[#A5A5A5]">æ¢å¾©é€Ÿç‡</span><span id="rateDetail" class="text-[#6D6875]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#A5A5A5]">é«”åŠ›ä¸Šé™</span><span id="maxDetail" class="text-[#6D6875]">--</span></div>
                    </div>
                    <button onclick="openBatchModal()" class="w-full mt-8 bg-[#8E9AAF] text-white py-5 rounded-[2rem] text-lg font-black shadow-md hover:bg-[#7D7684] transition-all active:scale-95">ğŸš€ æ‰¹é‡åŠ å…¥ç›£æ¸¬</button>
                </div>
            </div>

            <div class="xl:col-span-3">
                <div id="monitorGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                <div id="emptyDisplay" class="hidden text-center py-40 bg-[#FBFBF9] rounded-[3rem] border-4 border-dashed border-[#D7D3CC]">
                    <div class="text-6xl mb-6 opacity-20">ğŸ’¤</div>
                    <p class="text-[#D7D3CC] font-black text-2xl">ç›®å‰ç„¡é€²è¡Œä¸­çš„ç›£æ¸¬é …ç›®</p>
                    <p class="text-[#D7D3CC] font-bold mt-2">è«‹å¾å·¦å´é¸æ“‡æ´»å‹•ä¸¦åŠ å…¥äººç‰©</p>
                </div>
            </div>
        </div>
    </div>

    <div id="customPromptModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-[100] backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl relative border border-[#D7D3CC]">
            <h3 id="promptTitle" class="text-xl font-black mb-4 text-[#5E548E]">æç¤º</h3>
            <p id="promptSub" class="text-sm font-bold text-[#8E9AAF] mb-4"></p>
            <input id="promptInput" type="text" class="w-full p-4 bg-white border border-[#D7D3CC] rounded-2xl font-bold mb-6 outline-none focus:ring-2 focus:ring-[#FF9D6F]">
            <div class="flex gap-3">
                <button onclick="closeModal('customPromptModal')" class="flex-1 py-4 bg-[#D7D3CC] text-white rounded-2xl font-black hover:bg-[#C2BEB6]">å–æ¶ˆ</button>
                <button id="promptConfirmBtn" class="flex-1 py-4 bg-[#FF9D6F] text-white rounded-2xl font-black hover:bg-[#E88D5F]">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="manageModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-2xl rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-10 shadow-2xl relative flex flex-col max-h-[90vh] border border-[#D7D3CC]">
            <button onclick="closeModal('manageModal')" class="absolute top-6 right-6 md:top-10 md:right-10 text-[#D7D3CC] text-3xl hover:text-[#6D6875]">âœ•</button>
            <h3 class="text-2xl font-black mb-6 text-[#5E548E]">åå–®èˆ‡ç¾¤çµ„ç®¡ç†</h3>
            
            <div class="flex flex-wrap gap-2 mb-8 bg-white p-2 rounded-2xl border border-[#D7D3CC]">
                <input id="newGroupName" type="text" placeholder="è¼¸å…¥æ–°ç¾¤çµ„åç¨±..." class="flex-1 min-w-[150px] bg-transparent p-4 outline-none font-bold">
                <button onclick="addGroup()" class="bg-[#8E9AAF] text-white px-6 md:px-8 py-3 rounded-xl font-black hover:bg-[#7D7684] transition-all active:scale-95 whitespace-nowrap">å»ºç«‹ç¾¤çµ„</button>
            </div>
            
            <div id="groupListArea" class="overflow-y-auto flex-1 space-y-6 pr-2"></div>
        </div>
    </div>

    <div id="batchModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative flex flex-col max-h-[90vh] border border-[#D7D3CC]">
            <button onclick="closeModal('batchModal')" class="absolute top-10 right-10 text-[#D7D3CC] text-3xl">âœ•</button>
            <h3 class="text-2xl font-black mb-2 text-[#5E548E]">æ‰¹é‡åŠ å…¥ç›£æ¸¬</h3>
            <p id="batchActName" class="text-sm font-bold text-[#8E9AAF] mb-4"></p>
            <div class="flex justify-end gap-3 mb-4">
                <button onclick="toggleAllBatch(true)" class="text-xs font-black text-indigo-500 bg-indigo-50 px-3 py-1 rounded-lg">å…¨é¸</button>
                <button onclick="toggleAllBatch(false)" class="text-xs font-black text-[#AF7A7D] bg-red-50 px-3 py-1 rounded-lg">å–æ¶ˆå…¨é¸</button>
            </div>
            <div id="batchInputList" class="overflow-y-auto flex-1 space-y-6 mb-8 pr-2"></div>
            <button onclick="submitBatch()" class="w-full bg-[#8E9AAF] text-white py-6 rounded-[2rem] text-xl font-black shadow-lg hover:bg-[#7D7684]">ç¢ºèªä¸¦é–‹å§‹ç›£æ¸¬</button>
        </div>
    </div>

    <script>
        let activities = [];
        let db = JSON.parse(localStorage.getItem('stamina_v15_db')) || { groups: [{ id: 'default', name: 'æœªåˆ†é¡äººç‰©', members: [] }] };
        let monitors = JSON.parse(localStorage.getItem('stamina_v15_active')) || [];
        let sortMode = 0; 
        const sortTexts = ["æŒ‰æ´»å‹• (é è¨­)", "æŒ‰å›æ»¿æ™‚é•·", "æŒ‰ç¾¤çµ„åç¨±", "æŒ‰äººç‰©åç¨±"];

        window.onload = function() {
            const gameData = JSON.parse(sessionStorage.getItem('gameData'));
            if(!gameData) return location.href = "index.html"; 
            
            activities = gameData.activities;
            const select = document.getElementById('activitySelect');
            activities.forEach((act, idx) => {
                const opt = document.createElement('option'); 
                opt.value = idx; 
                opt.textContent = act.name;
                select.appendChild(opt);
            });

            select.onchange = () => {
                const act = activities[select.value];
                document.getElementById('rateDetail').innerText = `${act.minPerStamina} åˆ†é˜ / 1 é«”`;
                document.getElementById('maxDetail').innerText = `${act.maxStamina} é«”`;
            };
            
            select.dispatchEvent(new Event('change'));
            renderMonitoring();
            setInterval(renderMonitoring, 1000);
        };

        function renderMonitoring() {
            const grid = document.getElementById('monitorGrid');
            if(monitors.length === 0) {
                grid.innerHTML = "";
                document.getElementById('emptyDisplay').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyDisplay').classList.add('hidden');
            const now = Date.now();
            
            let list = monitors.map((m) => {
                const act = activities[m.actIdx];
                const mins = (now - m.startTime) / 60000;
                let current = Math.min(act.maxStamina, Math.max(0, m.initStamina + Math.floor(mins / act.minPerStamina)));
                const isFull = current >= act.maxStamina;
                let remSec = isFull ? 0 : ((act.maxStamina - current) * act.minPerStamina - (mins % act.minPerStamina)) * 60;
                return { ...m, current, isFull, remSec, actMax: act.maxStamina, actName: act.name, groupName: getGroupNameByCharId(m.charId) };
            });

            if(sortMode === 0) list.sort((a,b) => a.actName.localeCompare(b.actName));
            else if(sortMode === 1) list.sort((a,b) => a.remSec - b.remSec);
            else if(sortMode === 2) list.sort((a,b) => a.groupName.localeCompare(b.groupName));
            else if(sortMode === 3) list.sort((a,b) => a.charName.localeCompare(b.charName));

            grid.innerHTML = list.map(m => {
                const percent = (m.current / m.actMax) * 100;
                const ringColor = m.isFull ? '#02C874' : '#FF9D6F';
                const textColor = m.isFull ? 'text-full-green' : 'text-status-pink';
                let countdownText = m.isFull ? "é«”åŠ›å·²å›æ»¿" : `${Math.floor(m.remSec/3600)}æ™‚ ${Math.floor((m.remSec%3600)/60)}åˆ† ${Math.floor(m.remSec%60)}ç§’`;
                
                let fullTimeLabel = "ç‹€æ…‹ï¼šé«”åŠ›å·²å……æ»¿";
                if(!m.isFull) {
                    const d = new Date(now + m.remSec * 1000);
                    const Y = d.getFullYear();
                    const M = (d.getMonth()+1).toString().padStart(2,'0');
                    const D = d.getDate().toString().padStart(2,'0');
                    const hh = d.getHours().toString().padStart(2,'0');
                    const mm = d.getMinutes().toString().padStart(2,'0');
                    fullTimeLabel = `é è¨ˆå›æ»¿ï¼š${Y}/${M}/${D} ${hh}:${mm}`;
                }

                return `
                <div class="${m.isFull?'card-full-highlight':'card-standard'} p-8 rounded-[2.5rem] flex flex-col relative transition-all duration-500 shadow-sm">
                    <button onclick="removeMonitor('${m.charId}', ${m.actIdx})" class="absolute top-6 right-8 text-[#D7D3CC] hover:text-[#AF7A7D] text-2xl transition-colors">âœ•</button>
                    <div class="flex gap-2 mb-3">
                        <span class="tag-label">${m.actName}</span>
                        <span class="tag-label">${m.groupName}</span>
                    </div>
                    <div class="flex items-start justify-between mb-6">
                        <h4 class="text-2xl font-black text-[#6D6875]">${m.charName}</h4>
                        <div class="flex flex-col items-center">
                            <span class="text-[9px] font-black text-[#A5A5A5] uppercase mb-1">ç›®å‰é«”åŠ›</span>
                            <div onclick="quickUpdateStamina('${m.charId}', ${m.actIdx}, ${m.actMax})" class="relative w-20 h-20 cursor-pointer active:scale-90 transition-transform">
                                <svg class="w-20 h-20">
                                    <circle class="text-[#F0EFEB]" stroke-width="8" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40"/>
                                    <circle style="stroke: ${ringColor}" class="progress-ring-circle" stroke-width="8" stroke-dasharray="201" stroke-dashoffset="${201-(201*percent/100)}" stroke-linecap="round" fill="transparent" r="32" cx="40" cy="40"/>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center font-black">
                                    <span class="text-xl text-[#6D6875] leading-none">${m.current}</span>
                                    <span class="text-[7px] text-[#A5A5A5] mt-1 animate-guide">åˆ·æ–°é«”åŠ›</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/40 p-5 rounded-[1.5rem] border border-[#D7D3CC]/30">
                        <p class="text-3xl font-black ${textColor} tracking-tighter mb-1">${countdownText}</p>
                        <p class="text-[11px] font-bold text-[#8E9AAF] uppercase tracking-wider">${fullTimeLabel}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // --- åå–®ç®¡ç† UI ä¿®æ­£ç‰ˆ ---
        function renderManageUI() {
            const area = document.getElementById('groupListArea');
            area.innerHTML = db.groups.map((g, gi) => {
                const isDefault = g.id === 'default';
                return `
                <div class="bg-[#F4F2EE] p-5 md:p-6 rounded-[2rem] border border-[#D7D3CC] drop-zone" data-gid="${g.id}">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-xl font-black text-[#6D6875]">${g.name}</span>
                            ${!isDefault ? `
                            <button onclick="editGroupName('${g.id}')" class="fat-pencil-btn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="transform: scaleX(-1);">
                                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                </svg>
                            </button>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="askClearGroup('${g.id}')" class="text-xs text-[#AF7A7D] bg-white border border-[#AF7A7D] px-3 py-1.5 rounded-lg font-black hover:bg-red-50 transition-colors whitespace-nowrap">æ¸…ç©º</button>
                            ${!isDefault ? `<button onclick="askRemoveGroup(${gi})" class="text-xs text-white bg-[#AF7A7D] px-3 py-1.5 rounded-lg font-black hover:bg-[#9B6B6E] transition-colors whitespace-nowrap">åˆªé™¤</button>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-4 bg-white/50 p-1.5 rounded-xl border border-dashed border-[#D7D3CC]">
                        <input type="text" placeholder="æ–°å¢äººç‰©..." class="flex-1 min-w-[120px] p-3 rounded-lg text-sm font-bold border-none bg-white shadow-inner outline-none focus:ring-2 focus:ring-[#8E9AAF]">
                        <button onclick="addMemberInLine(this, '${g.id}')" class="bg-[#8E9AAF] text-white px-5 py-2.5 rounded-lg text-xs font-black transition-all active:scale-95 whitespace-nowrap">æ–°å¢</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 min-h-[50px] member-list" data-gid="${g.id}">
                        ${g.members.map((m, mi) => `
                            <div draggable="true" 
                                 ondragstart="handleDragStart(event, '${g.id}', ${mi})" 
                                 ondragend="handleDragEnd(event)"
                                 class="member-item bg-white p-3 rounded-xl text-sm font-black flex justify-between items-center border border-[#D7D3CC] cursor-move shadow-sm hover:shadow-md transition-all">
                                <span class="truncate pr-2">${m.name}</span>
                                <button onclick="removeMember('${g.id}', ${mi})" class="text-[#D7D3CC] hover:text-[#AF7A7D] flex-shrink-0">âœ•</button>
                            </div>`).join('')}
                    </div>
                </div>`;
            }).join('');
            setupDragAndDrop();
        }

        let dragInfo = null;
        function handleDragStart(e, gid, mi) {
            dragInfo = { gid, mi };
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(z => z.style.border = "1px solid #D7D3CC");
        }
        function setupDragAndDrop() {
            const zones = document.querySelectorAll('.drop-zone');
            zones.forEach(zone => {
                zone.ondragover = e => { e.preventDefault(); zone.style.border = "2px dashed #FF9D6F"; };
                zone.ondragleave = () => zone.style.border = "1px solid #D7D3CC";
                zone.ondrop = e => {
                    e.preventDefault();
                    zone.style.border = "1px solid #D7D3CC";
                    if (!dragInfo) return;
                    const targetGid = zone.dataset.gid;
                    const sGroup = db.groups.find(g => g.id === dragInfo.gid);
                    const tGroup = db.groups.find(g => g.id === targetGid);
                    const [movingItem] = sGroup.members.splice(dragInfo.mi, 1);
                    const listContainer = zone.querySelector('.member-list');
                    const siblings = [...listContainer.querySelectorAll('.member-item:not(.dragging)')];
                    const nextSibling = siblings.find(sibling => {
                        const box = sibling.getBoundingClientRect();
                        return e.clientY < box.top + box.height / 2 || (e.clientY < box.bottom && e.clientX < box.left + box.width / 2);
                    });
                    if (nextSibling) {
                        const nextIdx = tGroup.members.findIndex(m => m.name === nextSibling.querySelector('span').innerText);
                        tGroup.members.splice(nextIdx, 0, movingItem);
                    } else {
                        tGroup.members.push(movingItem);
                    }
                    saveDB(); renderManageUI(); renderMonitoring(); dragInfo = null;
                };
            });
        }

        function openBatchModal() {
            const actIdx = document.getElementById('activitySelect').value;
            const act = activities[actIdx];
            document.getElementById('batchActName').innerText = `æ­£åœ¨ç‚ºã€Œ${act.name}ã€åˆ†é…äººç‰©`;
            document.getElementById('batchInputList').innerHTML = db.groups.map(g => `
                <div class="bg-[#F4F2EE] p-5 rounded-[2rem] border border-[#D7D3CC]">
                    <div class="flex justify-between items-center mb-4 border-b border-[#D7D3CC] pb-2">
                        <span class="font-black text-[#6D6875]">${g.name}</span>
                        <div class="flex gap-2">
                            <button onclick="toggleGroupBatch('${g.id}', true)" class="text-[10px] font-black text-indigo-500 hover:underline">å…¨é¸æ­¤çµ„</button>
                            <button onclick="toggleGroupBatch('${g.id}', false)" class="text-[10px] font-black text-[#AF7A7D] hover:underline">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-2" data-batch-gid="${g.id}">
                        ${g.members.map(m => `
                            <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition-all">
                                <input type="checkbox" class="char-cb w-6 h-6 accent-[#FF9D6F]" data-name="${m.name}" data-id="${m.id}">
                                <span class="flex-1 font-black text-[#6D6875]">${m.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-black text-[#A5A5A5]">èµ·å§‹é«”åŠ›</span>
                                    <input type="number" class="stamina-input w-20 p-2 bg-[#F4F2EE] rounded-lg text-center font-black outline-none border-none focus:ring-2 focus:ring-[#8E9AAF]" value="0">
                                </div>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
            document.getElementById('batchModal').classList.replace('hidden', 'flex');
        }

        function toggleAllBatch(checked) { document.querySelectorAll('.char-cb').forEach(cb => cb.checked = checked); }
        function toggleGroupBatch(gid, checked) { document.querySelectorAll(`[data-batch-gid="${gid}"] .char-cb`).forEach(cb => cb.checked = checked); }

        function submitBatch() {
            const actIdx = document.getElementById('activitySelect').value;
            const cbs = document.querySelectorAll('.char-cb:checked');
            if (cbs.length === 0) return alert('è«‹é¸æ“‡è‡³å°‘ä¸€ä½äººç‰©');
            cbs.forEach(cb => {
                const row = cb.closest('.flex');
                const val = parseInt(row.querySelector('.stamina-input').value) || 0;
                const charId = cb.dataset.id;
                const data = { charId: charId, charName: cb.dataset.name, actIdx: actIdx, initStamina: val, startTime: Date.now() };
                const idx = monitors.findIndex(m => m.charId === charId && m.actIdx == actIdx);
                if(idx > -1) monitors[idx] = data; else monitors.push(data);
            });
            saveActive(); closeModal('batchModal'); renderMonitoring();
        }

        function quickUpdateStamina(charId, actIdx, maxStamina) {
            openCustomPrompt("å¿«é€Ÿåˆ·æ–°é«”åŠ›", `è¼¸å…¥ ${getCharName(charId)} çš„ç›®å‰é«”åŠ› (ä¸Šé™ï¼š${maxStamina})`, "0", false, (val) => {
                const num = parseInt(val);
                if (isNaN(num) || num < 0) return;
                const idx = monitors.findIndex(m => m.charId === charId && m.actIdx == actIdx);
                if(idx > -1) {
                    monitors[idx].initStamina = Math.min(num, maxStamina);
                    monitors[idx].startTime = Date.now();
                    saveActive(); renderMonitoring();
                }
            });
        }
        function getCharName(id) { for(let g of db.groups) { const m = g.members.find(m=>m.id===id); if(m) return m.name; } return "æœªçŸ¥"; }
        function editGroupName(gid) {
            const group = db.groups.find(g => g.id === gid);
            openCustomPrompt("ç·¨è¼¯ç¾¤çµ„åç¨±", "è«‹è¼¸å…¥æ–°åç¨±ï¼š", group.name, false, (n) => {
                if(n && n.trim() !== ""){ group.name = n.trim(); saveDB(); renderManageUI(); renderMonitoring(); }
            });
        }
        function openCustomPrompt(t, s, d, c, f) {
            document.getElementById('promptTitle').innerText = t;
            document.getElementById('promptSub').innerText = s;
            const inp = document.getElementById('promptInput');
            inp.style.display = c ? 'none' : 'block';
            inp.value = d || "";
            document.getElementById('customPromptModal').classList.replace('hidden', 'flex');
            document.getElementById('promptConfirmBtn').onclick = () => { f(inp.value); closeModal('customPromptModal'); };
        }
        function saveDB() { localStorage.setItem('stamina_v15_db', JSON.stringify(db)); }
        function saveActive() { localStorage.setItem('stamina_v15_active', JSON.stringify(monitors)); }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
        function openManageModal() { renderManageUI(); document.getElementById('manageModal').classList.replace('hidden', 'flex'); }
        function addGroup() { const n = document.getElementById('newGroupName').value; if(n){ db.groups.push({id:'g'+Date.now(), name:n, members:[]}); document.getElementById('newGroupName').value=""; saveDB(); renderManageUI(); }}
        function addMemberInLine(btn, gid) { const inp = btn.previousElementSibling; if(inp.value){ db.groups.find(g=>g.id===gid).members.push({name:inp.value, id:'c'+Date.now()}); inp.value=""; saveDB(); renderManageUI(); }}
        function removeMember(gid, mi) { const g = db.groups.find(g=>g.id===gid); g.members.splice(mi,1); saveDB(); renderManageUI(); }
        function getGroupNameByCharId(id) { for (let g of db.groups) { if (g.members.some(m => m.id === id)) return g.name; } return "æœªåˆ†é¡"; }
        function changeSort(dir) { sortMode = (sortMode + dir + 4) % 4; document.getElementById('sortModeText').innerText = sortTexts[sortMode]; renderMonitoring(); }
        function askClearAll() { openCustomPrompt("ç¢ºå®šæ¸…ç©ºï¼Ÿ", "é€™å°‡ç§»é™¤ä¸»ä»‹é¢ä¸Šæ‰€æœ‰æ­£åœ¨ç›£æ§çš„é«”åŠ›é …ç›®ã€‚", "", true, () => { monitors = []; saveActive(); renderMonitoring(); }); }
        function askClearGroup(gid) { openCustomPrompt("æ¸…ç©ºæˆå“¡ï¼Ÿ", "å°‡ç§»é™¤æ­¤ç¾¤çµ„å…§çš„æ‰€æœ‰äººç‰©ã€‚", "", true, () => { db.groups.find(g=>g.id===gid).members = []; saveDB(); renderManageUI(); }); }
        function askRemoveGroup(gi) { openCustomPrompt("åˆªé™¤ç¾¤çµ„ï¼Ÿ", "é€™å°‡æ°¸ä¹…åˆªé™¤æ­¤ç¾¤çµ„åŠå…¶æˆå“¡ã€‚", "", true, () => { db.groups.splice(gi,1); saveDB(); renderManageUI(); }); }
        function removeMonitor(charId, actIdx) { monitors = monitors.filter(m => !(m.charId === charId && m.actIdx == actIdx)); saveActive(); renderMonitoring(); }
    </script>
</body>
</html>
