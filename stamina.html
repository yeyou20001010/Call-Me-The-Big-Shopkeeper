<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>çµ‚æ¥µé«”åŠ›ç›£æ§ç³»çµ±</title>
    <style>
        .drag-over { border: 2px dashed #4f46e5 !important; background: #eef2ff !important; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-[2.5rem] shadow-sm gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-indigo-200 font-black italic">S</div>
                <div>
                    <h2 class="text-2xl font-black text-slate-800">é«”åŠ›ä¸­å¿ƒ</h2>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Multi-Activity & Drag-Drop Management</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openManageModal()" class="bg-indigo-50 text-indigo-600 px-6 py-2.5 rounded-2xl text-sm font-bold hover:bg-indigo-100 transition">ğŸ‘¥ åå–®ç®¡ç†</button>
                <button onclick="clearAllMonitoring()" class="bg-red-50 text-red-500 px-6 py-2.5 rounded-2xl text-sm font-bold hover:bg-red-100 transition">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ™‚é˜</button>
                <button onclick="location.href='portal.html'" class="bg-slate-900 text-white px-6 py-2.5 rounded-2xl text-sm font-bold">è¿”å›</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ¯</span> é¸æ“‡æ´»å‹•</h3>
                    <select id="activitySelect" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-indigo-600 outline-none border-2 border-transparent focus:border-indigo-500 mb-2"></select>
                    <div id="actDetail" class="text-[10px] font-bold text-slate-400 space-y-1 px-1">
                        <p id="rateDetail">--</p>
                    </div>
                    <button onclick="openBatchModal()" class="w-full mt-6 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:scale-[1.02] transition">ğŸš€ æ‰¹é‡åŠ å…¥ç›£æ¸¬</button>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div id="monitorGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                <div id="emptyDisplay" class="hidden text-center py-32 bg-white rounded-[3rem] border-4 border-dashed border-slate-100 text-slate-300 font-black">
                    ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•æ™‚é˜
                </div>
            </div>
        </div>
    </div>

    <div id="manageModal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-8 shadow-2xl relative flex flex-col max-h-[85vh]">
            <button onclick="closeModal('manageModal')" class="absolute top-8 right-8 text-slate-300 hover:text-slate-600 text-2xl">âœ•</button>
            <h3 class="text-2xl font-black mb-1 text-slate-800">åå–®ç®¡ç†</h3>
            <p class="text-[10px] text-slate-400 font-bold mb-6 uppercase">Drag to move characters between groups</p>
            
            <div class="flex gap-2 mb-6 bg-slate-50 p-3 rounded-[2rem]">
                <input id="newGroupName" type="text" placeholder="æ–°ç¾¤çµ„åç¨±..." class="flex-1 bg-white px-4 py-3 rounded-xl outline-none text-sm font-bold">
                <button onclick="addGroup()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold text-sm">æ–°å¢ç¾¤çµ„</button>
            </div>

            <div id="groupListArea" class="overflow-y-auto flex-1 space-y-4 pr-2">
                </div>
        </div>
    </div>

    <div id="batchModal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xl rounded-[3rem] p-8 shadow-2xl relative flex flex-col max-h-[85vh]">
            <button onclick="closeModal('batchModal')" class="absolute top-8 right-8 text-slate-300 hover:text-slate-600 text-2xl">âœ•</button>
            <h3 class="text-2xl font-black mb-2">æ‰¹é‡åŠ å…¥ç›£æ¸¬</h3>
            <div class="flex justify-between items-center mb-4">
                <p id="currentActName" class="text-xs font-bold text-indigo-500 uppercase"></p>
                <button onclick="toggleAllCheckboxes()" class="text-[10px] bg-slate-100 px-3 py-1 rounded-lg font-bold">å…¨é¸/å…¨å–æ¶ˆ</button>
            </div>
            
            <div id="batchInputList" class="overflow-y-auto flex-1 space-y-6 pr-2 mb-6"></div>

            <button onclick="submitBatch()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-100">é–‹å§‹è¨ˆæ™‚</button>
        </div>
    </div>

    <script>
        let activities = [];
        // è³‡æ–™åº«ï¼šåŒ…å«ç¾¤çµ„èˆ‡æˆå“¡
        let db = JSON.parse(localStorage.getItem('stamina_v4_db')) || {
            groups: [{ id: 'default', name: 'æœªåˆ†é¡äººç‰©', members: [] }]
        };
        // ç›£æ¸¬ä¸­ï¼š[ { charId, charName, actIdx, initStamina, startTime } ]
        let monitors = JSON.parse(localStorage.getItem('stamina_v4_active')) || [];

        window.onload = function() {
            const data = JSON.parse(sessionStorage.getItem('gameData'));
            if(!data) return location.href = "index.html";
            activities = data.activities;

            const select = document.getElementById('activitySelect');
            activities.forEach((act, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = act.name;
                select.appendChild(opt);
            });
            select.onchange = () => {
                const act = activities[select.value];
                document.getElementById('rateDetail').innerText = `æ¯ ${act.minPerStamina} åˆ†å› 1 é» / ä¸Šé™ ${act.maxStamina}`;
            };
            select.dispatchEvent(new Event('change'));

            renderMonitoring();
            setInterval(renderMonitoring, 1000);
        };

        // --- ç®¡ç†ä»‹é¢é‚è¼¯ (å«æ‹–æ›³) ---
        function renderManageUI() {
            const area = document.getElementById('groupListArea');
            area.innerHTML = db.groups.map((g, gi) => `
                <div class="bg-slate-50 p-6 rounded-[2rem] border-2 border-transparent transition-all group-container" 
                     ondragover="allowDrop(event)" ondrop="handleDrop(event, '${g.id}')">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-black text-slate-700">${g.name} ${g.id==='default'?'ğŸ“Œ':''}</span>
                        <div class="flex gap-2">
                            <button onclick="addMember('${g.id}')" class="text-[10px] text-indigo-500 font-bold uppercase">æ–°å¢äººç‰©</button>
                            ${g.id !== 'default' ? `<button onclick="removeGroup(${gi})" class="text-[10px] text-red-400 font-bold uppercase">åˆªé™¤</button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        ${g.members.map((m, mi) => `
                            <div draggable="true" ondragstart="handleDragStart(event, '${g.id}', ${mi})" 
                                 class="bg-white px-4 py-3 rounded-xl text-xs font-bold flex justify-between cursor-move hover:shadow-sm border border-slate-100">
                                <span>${m.name}</span>
                                <button onclick="removeMember('${g.id}', ${mi})" class="text-slate-200 hover:text-red-400">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        let draggedInfo = null;
        function handleDragStart(e, groupId, memberIdx) { draggedInfo = { groupId, memberIdx }; }
        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDrop(e, targetGroupId) {
            e.preventDefault();
            document.querySelectorAll('.group-container').forEach(el => el.classList.remove('drag-over'));
            if (!draggedInfo || draggedInfo.groupId === targetGroupId) return;

            const sourceGroup = db.groups.find(g => g.id === draggedInfo.groupId);
            const targetGroup = db.groups.find(g => g.id === targetGroupId);
            const [member] = sourceGroup.members.splice(draggedInfo.memberIdx, 1);
            targetGroup.members.push(member);
            
            saveDB();
            renderManageUI();
        }

        function addGroup() {
            const name = document.getElementById('newGroupName').value;
            if(!name) return;
            db.groups.push({ id: 'g'+Date.now(), name: name, members: [] });
            document.getElementById('newGroupName').value = "";
            saveDB(); renderManageUI();
        }

        function addMember(groupId) {
            const name = prompt("äººç‰©åç¨±ï¼š");
            if(name) {
                const group = db.groups.find(g => g.id === groupId);
                group.members.push({ name: name, id: 'c'+Date.now() });
                saveDB(); renderManageUI();
            }
        }

        // --- æ‰¹é‡åŠ å…¥ä»‹é¢ ---
        function openBatchModal() {
            const list = document.getElementById('batchInputList');
            const actIdx = document.getElementById('activitySelect').value;
            document.getElementById('currentActName').innerText = "ç›®æ¨™æ´»å‹•: " + activities[actIdx].name;

            list.innerHTML = db.groups.map(g => `
                <div class="bg-slate-50 p-5 rounded-[2rem]">
                    <div class="flex justify-between items-center mb-3">
                        <p class="text-[10px] font-black text-slate-400 uppercase">ç¾¤çµ„: ${g.name}</p>
                        <button onclick="toggleGroupCheckboxes(this)" class="text-[10px] text-indigo-500 font-bold">æ­¤çµ„å…¨é¸</button>
                    </div>
                    <div class="space-y-2">
                        ${g.members.map(m => `
                            <div class="flex items-center gap-3 bg-white p-3 rounded-xl">
                                <input type="checkbox" class="char-cb w-5 h-5 rounded-lg text-indigo-600" data-name="${m.name}" data-id="${m.id}">
                                <span class="flex-1 font-bold text-slate-700 text-sm">${m.name}</span>
                                <input type="number" class="w-16 p-2 bg-slate-50 rounded-lg text-center font-mono font-bold text-sm" value="0">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('batchModal').classList.replace('hidden', 'flex');
        }

        function toggleGroupCheckboxes(btn) {
            const checkboxes = btn.closest('div').parentElement.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        }

        function toggleAllCheckboxes() {
            const checkboxes = document.querySelectorAll('.char-cb');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        }

        function submitBatch() {
            const actIdx = document.getElementById('activitySelect').value;
            const rows = document.querySelectorAll('#batchInputList .bg-white');
            const now = Date.now();

            rows.forEach(row => {
                const cb = row.querySelector('input[type="checkbox"]');
                const val = parseInt(row.querySelector('input[type="number"]').value) || 0;
                if(cb.checked) {
                    // åŒä¸€å€‹è§’è‰²ã€åŒä¸€å€‹æ´»å‹•ï¼Œè‹¥é‡è¤‡å‰‡æ›´æ–°
                    const existingIdx = monitors.findIndex(m => m.charId === cb.dataset.id && m.actIdx == actIdx);
                    const data = {
                        charId: cb.dataset.id,
                        charName: cb.dataset.name,
                        actIdx: actIdx,
                        initStamina: val,
                        startTime: now
                    };
                    if(existingIdx > -1) monitors[existingIdx] = data;
                    else monitors.push(data);
                }
            });
            saveActive();
            closeModal('batchModal');
            renderMonitoring();
        }

        // --- æ¸²æŸ“å¡ç‰‡ (å¤šæ´»å‹•ä¸¦å­˜) ---
        function renderMonitoring() {
            const grid = document.getElementById('monitorGrid');
            const empty = document.getElementById('emptyDisplay');
            if(monitors.length === 0) { grid.innerHTML = ""; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            const now = Date.now();
            grid.innerHTML = monitors.map((m, idx) => {
                const act = activities[m.actIdx];
                const mins = (now - m.startTime)/60000;
                const recovered = Math.floor(mins / act.minPerStamina);
                const current = Math.min(act.maxStamina, m.initStamina + recovered);
                const percent = (current / act.maxStamina) * 100;
                const isFull = current >= act.maxStamina;
                
                let timer = "FULL";
                if(!isFull) {
                    const remMins = (act.maxStamina - current)*act.minPerStamina - (mins % act.minPerStamina);
                    timer = `${Math.floor(remMins/60)}h ${Math.floor(remMins%60)}m ${Math.floor((remMins*60)%60)}s`;
                }

                return `
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex items-center gap-6 relative group">
                    <button onclick="removeMonitor(${idx})" class="absolute top-4 right-4 text-slate-200 group-hover:text-red-400">âœ•</button>
                    <div class="relative w-16 h-16 shrink-0">
                        <svg class="w-16 h-16"><circle class="text-slate-50" stroke-width="6" stroke="currentColor" fill="transparent" r="25" cx="32" cy="32"/>
                        <circle class="${isFull?'text-green-500':'text-indigo-600'}" stroke-width="6" stroke-dasharray="157" stroke-dashoffset="${157-(157*percent/100)}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="25" cx="32" cy="32"/></svg>
                        <div class="absolute inset-0 flex items-center justify-center font-black text-slate-800 text-xs">${current}</div>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-[9px] font-bold text-indigo-400 uppercase truncate">${act.name}</p>
                        <h4 class="font-black text-slate-800 truncate">${m.charName}</h4>
                        <p class="text-lg font-black ${isFull?'text-green-500':'text-slate-900'} font-mono">${timer}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // --- è¼”åŠ©å‡½å¼ ---
        function removeMember(groupId, mIdx) { 
            const g = db.groups.find(g => g.id === groupId);
            const memberId = g.members[mIdx].id;
            g.members.splice(mIdx, 1);
            // åˆªé™¤äººç‰©æ™‚ï¼Œé€£åŒå…¶ç›£æ§ä¸€èµ·åˆªé™¤
            monitors = monitors.filter(m => m.charId !== memberId);
            saveDB(); saveActive(); renderManageUI(); renderMonitoring();
        }
        function removeMonitor(idx) { monitors.splice(idx, 1); saveActive(); renderMonitoring(); }
        function clearAllMonitoring() { if(confirm("æ¸…ç©ºæ‰€æœ‰æ™‚é˜ï¼Ÿ")) { monitors = []; saveActive(); renderMonitoring(); } }
        function saveDB() { localStorage.setItem('stamina_v4_db', JSON.stringify(db)); }
        function saveActive() { localStorage.setItem('stamina_v4_active', JSON.stringify(monitors)); }
        function openManageModal() { renderManageUI(); document.getElementById('manageModal').classList.replace('hidden', 'flex'); }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
    </script>
</body>
</html>
