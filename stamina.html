<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>é«”åŠ›ç›£æ§ä¸­å¿ƒ - è«è˜­è¿ªæ¥µç°¡ç‰ˆ</title>
    <style>
        /* å¼·åˆ¶å¾®è»Ÿæ­£é»‘é«” */
        body { 
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; 
            background-color: #E2E2E2; /* è«è˜­è¿ªåº•è‰² */
        }
        
        /* è«è˜­è¿ªé…è‰²æ–¹æ¡ˆ */
        :root {
            --morandi-blue: #8E9AAF;
            --morandi-green: #B9C6AE;
            --morandi-orange: #D8A48F; /* è±†æ²™æ©˜ */
            --morandi-bg: #F0EFEB;
            --morandi-dark: #6D6875;
        }

        .morandi-card { background-color: #F8F7F5; border-color: #D7D3CC; }
        .morandi-card-full { background-color: #E8EDDE !important; border-color: #B9C6AE !important; }
        .text-morandi-orange { color: #D8A48F; }
        .text-morandi-green { color: #6B8E23; }
        
        .progress-ring-circle { transition: stroke-dashoffset 0.8s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        /* æŒ‰éˆ•è«è˜­è¿ªé¢¨æ ¼ */
        .btn-morandi-primary { background-color: #8E9AAF; color: white; }
        .btn-morandi-primary:hover { background-color: #7A869A; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10 text-[#6D6875]">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col lg:flex-row justify-between items-center mb-10 bg-[#F8F7F5] p-8 rounded-[2rem] shadow-sm border border-[#D7D3CC] gap-6">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-[#8E9AAF] rounded-2xl flex items-center justify-center text-white text-3xl shadow-sm font-black">âš¡</div>
                <div>
                    <h2 class="text-3xl font-black text-[#5E548E] tracking-tight">é«”åŠ›ç›£æ§ä¸­å¿ƒ</h2>
                    <p class="text-xs font-bold text-[#8E9AAF] uppercase tracking-widest">Morandi Professional Monitoring</p>
                </div>
            </div>
            
            <div class="flex gap-2 flex-wrap justify-center items-center">
                <div class="flex items-center bg-[#ECE9E4] rounded-2xl p-1 border border-[#D7D3CC]">
                    <button onclick="changeSort(-1)" class="p-3 hover:bg-white rounded-xl transition text-xl">â®</button>
                    <div class="px-4 min-w-[140px] text-center">
                        <p class="text-[10px] font-bold text-[#A5A5A5] uppercase tracking-tighter">æ’åºæ¨¡å¼</p>
                        <span id="sortModeText" class="font-black text-sm">æŒ‰æ´»å‹• (é è¨­)</span>
                    </div>
                    <button onclick="changeSort(1)" class="p-3 hover:bg-white rounded-xl transition text-xl">â¯</button>
                </div>

                <button onclick="openManageModal()" class="bg-[#B8B0A5] text-white px-6 py-4 rounded-2xl text-base font-black hover:opacity-90 transition">ğŸ‘¥ åå–®ç®¡ç†</button>
                <button onclick="clearAllMonitoring()" class="bg-[#E5989B] text-white px-6 py-4 rounded-2xl text-base font-black hover:opacity-90 transition">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <div class="xl:col-span-1 space-y-6">
                <div class="bg-[#F8F7F5] p-8 rounded-[2.5rem] shadow-sm border border-[#D7D3CC]">
                    <h3 class="text-lg font-black text-[#6D6875] mb-6 flex items-center gap-2 border-b border-[#E0DDD7] pb-4">ğŸ“… æ´»å‹•é¸æ“‡</h3>
                    <select id="activitySelect" class="w-full p-4 bg-white rounded-2xl font-black text-lg text-[#8E9AAF] outline-none border border-[#D7D3CC] focus:ring-2 ring-[#8E9AAF] mb-4"></select>
                    <div id="actDetail" class="bg-[#F0EFEB] p-5 rounded-2xl space-y-2 text-sm font-bold border border-[#E0DDD7]">
                        <p>é€Ÿç‡ï¼š<span id="rateDetail" class="text-[#8E9AAF]">--</span></p>
                        <p>ä¸Šé™ï¼š<span id="maxDetail" class="text-[#8E9AAF]">--</span></p>
                    </div>
                    <button onclick="openBatchModal()" class="w-full mt-8 bg-[#8E9AAF] text-white py-5 rounded-[2rem] text-lg font-black shadow-md hover:brightness-95 transition-all">ğŸš€ æ‰¹é‡å•Ÿå‹•</button>
                </div>
            </div>

            <div class="xl:col-span-3">
                <div id="monitorGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
                <div id="emptyDisplay" class="hidden text-center py-40 bg-[#F8F7F5] rounded-[3rem] border-4 border-dashed border-[#D7D3CC]">
                    <p class="text-[#D7D3CC] font-black text-2xl italic">å°šç„¡æ´»å‹•ç›£æ¸¬ä¸­</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let activities = [];
        let db = JSON.parse(localStorage.getItem('stamina_v7_db')) || { groups: [{ id: 'default', name: 'æœªåˆ†é¡äººç‰©', members: [] }] };
        let monitors = JSON.parse(localStorage.getItem('stamina_v7_active')) || [];
        let sortMode = 0; 
        const sortTexts = ["æŒ‰æ´»å‹• (é è¨­)", "æŒ‰å›æ»¿æ™‚é•·", "æŒ‰ç¾¤çµ„åç¨±", "æŒ‰äººç‰©åç¨±"];

        window.onload = function() {
            const data = JSON.parse(sessionStorage.getItem('gameData'));
            if(!data) return location.href = "index.html";
            activities = data.activities;

            const select = document.getElementById('activitySelect');
            activities.forEach((act, idx) => {
                const opt = document.createElement('option'); opt.value = idx; opt.textContent = act.name;
                select.appendChild(opt);
            });
            select.onchange = () => {
                const act = activities[select.value];
                document.getElementById('rateDetail').innerText = `${act.minPerStamina} åˆ† / é»`;
                document.getElementById('maxDetail').innerText = `${act.maxStamina} é»`;
            };
            select.dispatchEvent(new Event('change'));
            renderMonitoring();
            setInterval(renderMonitoring, 1000);
        };

        function changeSort(dir) {
            sortMode = (sortMode + dir + 4) % 4;
            document.getElementById('sortModeText').innerText = sortTexts[sortMode];
            renderMonitoring();
        }

        function getGroupNameByCharId(charId) {
            for (let g of db.groups) {
                if (g.members.some(m => m.id === charId)) return g.name;
            }
            return "ğŸ“Œ æœªåˆ†é¡äººç‰©";
        }

        function renderMonitoring() {
            const grid = document.getElementById('monitorGrid');
            if(monitors.length === 0) { grid.innerHTML = ""; document.getElementById('emptyDisplay').classList.remove('hidden'); return; }
            document.getElementById('emptyDisplay').classList.add('hidden');

            const now = Date.now();
            let list = monitors.map((m, idx) => {
                const act = activities[m.actIdx];
                const mins = (now - m.startTime) / 60000;
                const current = Math.min(act.maxStamina, m.initStamina + Math.floor(mins / act.minPerStamina));
                const isFull = current >= act.maxStamina;
                let remSec = isFull ? 0 : ((act.maxStamina - current) * act.minPerStamina - (mins % act.minPerStamina)) * 60;
                return { ...m, current, isFull, remSec, actName: act.name, actMax: act.maxStamina, groupName: getGroupNameByCharId(m.charId), originalIdx: idx };
            });

            // æ’åº
            if(sortMode === 0) list.sort((a, b) => a.actName.localeCompare(b.actName));
            else if(sortMode === 1) list.sort((a, b) => a.remSec - b.remSec);
            else if(sortMode === 2) list.sort((a, b) => a.groupName.localeCompare(b.groupName));
            else if(sortMode === 3) list.sort((a, b) => a.charName.localeCompare(b.charName));

            grid.innerHTML = list.map(m => {
                const percent = (m.current / m.actMax) * 100;
                const cardClass = m.isFull ? 'morandi-card-full' : 'morandi-card';
                const timeClass = m.isFull ? 'text-morandi-green' : 'text-morandi-orange';
                
                let countdown = "å·²å›æ»¿";
                if(!m.isFull) {
                    const h = Math.floor(m.remSec / 3600);
                    const min = Math.floor((m.remSec % 3600) / 60);
                    const sec = Math.floor(m.remSec % 60);
                    countdown = `${h}æ™‚ ${min}åˆ† ${sec}ç§’`;
                }

                return `
                <div class="${cardClass} p-8 rounded-[2.5rem] shadow-sm border flex flex-col relative transition-all duration-500">
                    <button onclick="removeMonitor(${m.originalIdx})" class="absolute top-6 right-8 text-[#D7D3CC] hover:text-red-400 text-2xl">âœ•</button>
                    
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex-1 pr-2">
                            <div class="flex gap-2 mb-2">
                                <span class="bg-white/60 border border-[#D7D3CC] px-2 py-0.5 rounded text-[10px] font-bold text-[#8E9AAF] uppercase">${m.actName}</span>
                                <span class="bg-white/60 border border-[#D7D3CC] px-2 py-0.5 rounded text-[10px] font-bold text-[#8E9AAF] uppercase">${m.groupName}</span>
                            </div>
                            <h4 class="text-2xl font-black text-[#6D6875] tracking-tight">${m.charName}</h4>
                        </div>
                        <div class="relative w-20 h-20 shrink-0">
                            <svg class="w-20 h-20"><circle class="text-white/40" stroke-width="8" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40"/>
                            <circle class="${m.isFull?'text-[#B9C6AE]':'text-[#8E9AAF]'} progress-ring-circle" stroke-width="8" stroke-dasharray="201" stroke-dashoffset="${201-(201*percent/100)}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40"/></svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-xl font-black text-[#6D6875] leading-none">${m.current}</span>
                                <span class="text-[7px] font-bold text-[#A5A5A5] uppercase mt-1">é«”åŠ›</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/40 p-5 rounded-[1.5rem] border border-white/50">
                        <p class="text-[10px] font-black text-[#A5A5A5] uppercase tracking-widest mb-1">ç‹€æ…‹å€’è¨ˆæ™‚</p>
                        <p class="text-3xl font-black ${timeClass} font-mono tracking-tighter">${countdown}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // åå–®ç®¡ç†èˆ‡æ‰¹é‡é‚è¼¯ (æ¨£å¼å·²åœ¨çµ„ä»¶ä¸­åŒæ­¥ç‚ºè«è˜­è¿ªè‰²ç³»)
        function openManageModal() { renderManageUI(); document.getElementById('manageModal').classList.replace('hidden', 'flex'); }
        function openBatchModal() { /* ...åŒ V6ï¼Œå·²æ›´æ–°ç‚ºè«è˜­è¿ªé¡è‰²... */ }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
        function removeMonitor(idx) { monitors.splice(idx, 1); saveActive(); renderMonitoring(); }
        function saveDB() { localStorage.setItem('stamina_v7_db', JSON.stringify(db)); }
        function saveActive() { localStorage.setItem('stamina_v7_active', JSON.stringify(monitors)); }
        
        // --- æ‰¹é‡åŠ å…¥èˆ‡ç®¡ç† UI çœç•¥éƒ¨åˆ† (å…§å®¹é‚è¼¯ä¸è®Šï¼Œåƒ…é…è‰²æ”¹ç‚ºè«è˜­è¿ª) ---
    </script>
    
    </body>
</html>
