<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>é«”åŠ›ç›£æ§ä¸­å¿ƒ - æ™ºæ…§æ’åºç‰ˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .progress-ring-circle { transition: stroke-dashoffset 0.8s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .drag-over { border: 3px dashed #6366f1 !important; background: #f5f3ff !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col lg:flex-row justify-between items-center mb-10 bg-white p-8 rounded-[3rem] shadow-xl border border-slate-200 gap-6">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-indigo-600 rounded-[1.5rem] flex items-center justify-center text-white text-3xl shadow-lg shadow-indigo-200 font-black">âš¡</div>
                <div>
                    <h2 class="text-3xl font-black text-slate-800 tracking-tight">é«”åŠ›ç›£æ§ä¸­å¿ƒ</h2>
                    <p class="text-sm font-bold text-indigo-500 uppercase tracking-widest">Multi-Group & Smart Sorting</p>
                </div>
            </div>
            <div class="flex gap-3 flex-wrap justify-center">
                <button id="sortBtn" onclick="toggleSort()" class="bg-amber-100 text-amber-700 px-6 py-4 rounded-2xl text-lg font-black hover:bg-amber-200 transition flex items-center gap-2 border-2 border-amber-200">
                    <span>ğŸ”„</span> æ’åºï¼š<span id="sortModeText">æŒ‰æ´»å‹• (é è¨­)</span>
                </button>
                <button onclick="openManageModal()" class="bg-indigo-50 text-indigo-700 px-6 py-4 rounded-2xl text-lg font-black hover:bg-indigo-100 transition">ğŸ‘¥ åå–®ç®¡ç†</button>
                <button onclick="clearAllMonitoring()" class="bg-red-50 text-red-500 px-6 py-4 rounded-2xl text-lg font-black hover:bg-red-100 transition">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                <button onclick="location.href='portal.html'" class="bg-slate-900 text-white px-6 py-4 rounded-2xl text-lg font-black">è¿”å›</button>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <div class="xl:col-span-1 space-y-6">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-lg border border-slate-100">
                    <h3 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-2 border-b pb-4"><span>ğŸ“…</span> é¸æ“‡ç›®å‰æ´»å‹•</h3>
                    <select id="activitySelect" class="w-full p-5 bg-slate-50 rounded-2xl font-black text-lg text-indigo-600 outline-none border-2 border-transparent focus:border-indigo-500 mb-4 shadow-inner"></select>
                    <div id="actDetail" class="bg-indigo-50 p-5 rounded-2xl space-y-2">
                        <p class="text-sm font-bold text-indigo-700">å›é«”é€Ÿç‡ï¼š<span id="rateDetail" class="font-black">--</span></p>
                        <p class="text-sm font-bold text-indigo-700">é«”åŠ›ä¸Šé™ï¼š<span id="maxDetail" class="font-black">--</span></p>
                    </div>
                    <button onclick="openBatchModal()" class="w-full mt-8 bg-indigo-600 text-white py-6 rounded-[2rem] text-xl font-black shadow-xl shadow-indigo-100 hover:-translate-y-1 transition-all">ğŸš€ æ‰¹é‡å•Ÿå‹•ç›£æ¸¬</button>
                </div>
            </div>

            <div class="xl:col-span-3">
                <div id="monitorGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 text-slate-800">
                    </div>
                <div id="emptyDisplay" class="hidden text-center py-40 bg-white rounded-[3rem] border-4 border-dashed border-slate-200">
                    <p class="text-slate-300 font-black text-2xl italic">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•æ™‚é˜</p>
                </div>
            </div>
        </div>
    </div>

    <div id="batchModal" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="closeModal('batchModal')" class="absolute top-10 right-10 text-slate-300 hover:text-slate-600 text-3xl">âœ•</button>
            <h3 class="text-3xl font-black mb-2 text-slate-800">æ‰¹é‡åŠ å…¥ç›£æ¸¬</h3>
            <div class="flex justify-between items-center mb-8 border-b pb-4">
                <p id="currentActName" class="text-lg font-bold text-indigo-600"></p>
                <button onclick="toggleAllCheckboxes()" class="bg-slate-100 px-5 py-2 rounded-xl font-bold text-sm">å…¨é¸ / å–æ¶ˆ</button>
            </div>
            <div id="batchInputList" class="overflow-y-auto flex-1 space-y-6 pr-4 mb-8 text-lg"></div>
            <button onclick="submitBatch()" class="w-full bg-indigo-600 text-white py-6 rounded-[2rem] text-xl font-black">ç¢ºèªåŠ å…¥</button>
        </div>
    </div>

    <div id="manageModal" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="closeModal('manageModal')" class="absolute top-10 right-10 text-slate-300 hover:text-slate-600 text-3xl">âœ•</button>
            <h3 class="text-3xl font-black mb-8 text-slate-800">åå–®èˆ‡ç¾¤çµ„ç®¡ç†</h3>
            <div class="flex gap-4 mb-8">
                <input id="newGroupName" type="text" placeholder="æ–°ç¾¤çµ„åç¨±..." class="flex-1 bg-slate-100 p-5 rounded-2xl outline-none text-xl font-bold">
                <button onclick="addGroup()" class="bg-indigo-600 text-white px-10 rounded-2xl font-black text-xl">æ–°å¢</button>
            </div>
            <div id="groupListArea" class="overflow-y-auto flex-1 space-y-8 pr-4"></div>
        </div>
    </div>

    <script>
        let activities = [];
        let db = JSON.parse(localStorage.getItem('stamina_v6_db')) || { groups: [{ id: 'default', name: 'æœªåˆ†é¡äººç‰©', members: [] }] };
        let monitors = JSON.parse(localStorage.getItem('stamina_v6_active')) || [];
        let sortMode = 0; // 0: æŒ‰æ´»å‹•, 1: æŒ‰å›æ»¿æ™‚é•·, 2: æŒ‰ç¾¤çµ„, 3: æŒ‰äººç‰©

        window.onload = function() {
            const data = JSON.parse(sessionStorage.getItem('gameData'));
            if(!data) return location.href = "index.html";
            activities = data.activities;

            const select = document.getElementById('activitySelect');
            activities.forEach((act, idx) => {
                const opt = document.createElement('option'); opt.value = idx; opt.textContent = act.name;
                select.appendChild(opt);
            });
            select.onchange = () => {
                const act = activities[select.value];
                document.getElementById('rateDetail').innerText = `${act.minPerStamina} åˆ†é˜ / 1 é»`;
                document.getElementById('maxDetail').innerText = `${act.maxStamina} é»`;
            };
            select.dispatchEvent(new Event('change'));
            renderMonitoring();
            setInterval(renderMonitoring, 1000);
        };

        function toggleSort() {
            sortMode = (sortMode + 1) % 4;
            const texts = ["æŒ‰æ´»å‹• (é è¨­)", "æŒ‰å›æ»¿æ™‚é•·", "æŒ‰ç¾¤çµ„åç¨±", "æŒ‰äººç‰©åç¨±"];
            document.getElementById('sortModeText').innerText = texts[sortMode];
            renderMonitoring();
        }

        // è¼”åŠ©å‡½å¼ï¼šå°‹æ‰¾æŸå€‹äººç‰©å±¬æ–¼å“ªå€‹ç¾¤çµ„
        function getGroupNameByCharId(charId) {
            for (let g of db.groups) {
                if (g.members.some(m => m.id === charId)) return g.name;
            }
            return "ğŸ“Œ æœªåˆ†é¡äººç‰©";
        }

        function formatFullTime(ms) {
            const d = new Date(ms);
            return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function renderMonitoring() {
            const grid = document.getElementById('monitorGrid');
            if(monitors.length === 0) { grid.innerHTML = ""; document.getElementById('emptyDisplay').classList.remove('hidden'); return; }
            document.getElementById('emptyDisplay').classList.add('hidden');

            const now = Date.now();
            let displayList = monitors.map((m, idx) => {
                const act = activities[m.actIdx];
                const minsPassed = (now - m.startTime) / 60000;
                const recovered = Math.floor(minsPassed / act.minPerStamina);
                const current = Math.min(act.maxStamina, m.initStamina + recovered);
                const isFull = current >= act.maxStamina;
                let remSec = isFull ? 0 : ((act.maxStamina - current) * act.minPerStamina - (minsPassed % act.minPerStamina)) * 60;
                
                return { 
                    ...m, current, isFull, remSec, 
                    actName: act.name, actMax: act.maxStamina, 
                    groupName: getGroupNameByCharId(m.charId),
                    originalIdx: idx 
                };
            });

            // å››æ…‹æ’åºé‚è¼¯
            if(sortMode === 0) displayList.sort((a, b) => a.actName.localeCompare(b.actName));
            else if(sortMode === 1) displayList.sort((a, b) => a.remSec - b.remSec);
            else if(sortMode === 2) displayList.sort((a, b) => a.groupName.localeCompare(b.groupName));
            else if(sortMode === 3) displayList.sort((a, b) => a.charName.localeCompare(b.charName));

            grid.innerHTML = displayList.map((m) => {
                const percent = (m.current / m.actMax) * 100;
                const fullTimeText = m.isFull ? "ç›®å‰ç‹€æ…‹ï¼šå·²å›æ»¿" : `é è¨ˆå›æ»¿ï¼š${formatFullTime(now + m.remSec * 1000)}`;
                
                let countdown = "READY (FULL)";
                if(!m.isFull) {
                    const h = Math.floor(m.remSec / 3600);
                    const min = Math.floor((m.remSec % 3600) / 60);
                    const sec = Math.floor(m.remSec % 60);
                    countdown = `${h}h ${min}m ${sec}s`;
                }

                return `
                <div class="bg-white p-8 rounded-[3rem] shadow-md border border-slate-200 flex flex-col relative group hover:shadow-2xl transition-all">
                    <button onclick="removeMonitor(${m.originalIdx})" class="absolute top-6 right-8 text-slate-300 hover:text-red-500 text-2xl">âœ•</button>
                    
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex-1 pr-4">
                            <div class="flex gap-2 flex-wrap mb-2">
                                <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-xs font-black uppercase tracking-widest">${m.actName}</span>
                                <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-lg text-xs font-black uppercase tracking-widest">${m.groupName}</span>
                            </div>
                            <h4 class="text-2xl font-black text-slate-800 mt-1 truncate">${m.charName}</h4>
                        </div>
                        <div class="relative w-24 h-24 shrink-0 shadow-inner rounded-full p-1 bg-slate-50">
                            <svg class="w-full h-full"><circle class="text-slate-100" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="44" cy="44"/>
                            <circle class="${m.isFull?'text-green-500':'text-indigo-600'} progress-ring-circle" stroke-width="10" stroke-dasharray="251" stroke-dashoffset="${251-(251*percent/100)}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="44" cy="44"/></svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-2xl font-black text-slate-800 leading-none">${m.current}</span>
                                <span class="text-[8px] font-bold text-slate-400 uppercase mt-1">é«”åŠ›é»æ•¸</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4 bg-slate-50 p-6 rounded-[2rem] border border-slate-100">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">è·é›¢å›æ»¿å€’è¨ˆæ™‚</p>
                            <p class="text-3xl font-black ${m.isFull?'text-green-500':'text-slate-900'} font-mono tracking-tighter">${countdown}</p>
                        </div>
                        <div class="border-t border-slate-200 pt-3">
                            <p class="text-xs font-bold text-slate-500">${fullTimeText}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- ç®¡ç†ä»‹é¢æ¸²æŸ“ ---
        function renderManageUI() {
            const area = document.getElementById('groupListArea');
            area.innerHTML = db.groups.map((g, gi) => `
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border-2 border-transparent transition-all group-container" ondragover="allowDrop(event)" ondrop="handleDrop(event, '${g.id}')">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-2xl font-black text-slate-700">${g.name} ${g.id==='default'?'ğŸ“Œ':''}</span>
                        <div class="flex gap-4">
                            <button onclick="addMember('${g.id}')" class="text-base text-indigo-600 font-black">ï¼‹æ–°å¢äººç‰©</button>
                            ${g.id !== 'default' ? `<button onclick="removeGroup(${gi})" class="text-base text-red-400 font-bold">åˆªé™¤çµ„</button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        ${g.members.map((m, mi) => `
                            <div draggable="true" ondragstart="handleDragStart(event, '${g.id}', ${mi})" class="bg-white p-5 rounded-2xl text-lg font-bold flex justify-between shadow-sm cursor-move border border-slate-200 hover:border-indigo-300">
                                <span>${m.name}</span>
                                <button onclick="removeMember('${g.id}', ${mi})" class="text-slate-200 hover:text-red-500">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                </div>`).join('');
        }

        // --- å…¶é¤˜é‚è¼¯å°è£ (Batch, DragDrop, etc.) ---
        function addGroup() {
            const name = document.getElementById('newGroupName').value;
            if(!name) return;
            db.groups.push({ id: 'g'+Date.now(), name: name, members: [] });
            document.getElementById('newGroupName').value = "";
            saveDB(); renderManageUI();
        }
        function addMember(groupId) {
            const name = prompt("è«‹è¼¸å…¥äººç‰©åç¨±ï¼š");
            if(name) {
                db.groups.find(g => g.id === groupId).members.push({ name: name, id: 'c'+Date.now() });
                saveDB(); renderManageUI();
            }
        }
        function openManageModal() { renderManageUI(); document.getElementById('manageModal').classList.replace('hidden', 'flex'); }
        function openBatchModal() {
            const actIdx = document.getElementById('activitySelect').value;
            document.getElementById('currentActName').innerText = "ğŸ“ æ­£åœ¨åŠ å…¥æ´»å‹•ï¼š" + activities[actIdx].name;
            document.getElementById('batchInputList').innerHTML = db.groups.map(g => `
                <div class="bg-slate-50 p-6 rounded-[2rem] mb-6">
                    <div class="flex justify-between mb-4"><span class="font-black text-slate-500">ç¾¤çµ„ï¼š${g.name}</span><button onclick="toggleGroupCheckboxes(this)" class="text-sm text-indigo-500 font-bold">æ­¤çµ„å…¨é¸</button></div>
                    <div class="space-y-3">
                        ${g.members.map(m => `
                            <div class="flex items-center gap-4 bg-white p-5 rounded-2xl shadow-sm">
                                <input type="checkbox" class="char-cb w-6 h-6 rounded-lg text-indigo-600" data-name="${m.name}" data-id="${m.id}">
                                <span class="flex-1 font-black text-slate-700">${m.name}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-slate-400">ç›®å‰é«”åŠ›</span>
                                    <input type="number" class="w-24 p-2 bg-slate-100 rounded-xl text-center font-black text-lg" value="0">
                                </div>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
            document.getElementById('batchModal').classList.replace('hidden', 'flex');
        }
        function submitBatch() {
            const actIdx = document.getElementById('activitySelect').value;
            const now = Date.now();
            document.querySelectorAll('#batchInputList .bg-white').forEach(row => {
                const cb = row.querySelector('input[type="checkbox"]');
                const val = parseInt(row.querySelector('input[type="number"]').value) || 0;
                if(cb.checked) {
                    const existingIdx = monitors.findIndex(m => m.charId === cb.dataset.id && m.actIdx == actIdx);
                    const data = { charId: cb.dataset.id, charName: cb.dataset.name, actIdx: actIdx, initStamina: val, startTime: now };
                    if(existingIdx > -1) monitors[existingIdx] = data; else monitors.push(data);
                }
            });
            saveActive(); closeModal('batchModal'); renderMonitoring();
        }

        let draggedInfo = null;
        function handleDragStart(e, groupId, memberIdx) { draggedInfo = { groupId, memberIdx }; }
        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDrop(e, targetGroupId) {
            e.preventDefault(); document.querySelectorAll('.group-container').forEach(el => el.classList.remove('drag-over'));
            if (!draggedInfo || draggedInfo.groupId === targetGroupId) return;
            const sourceGroup = db.groups.find(g => g.id === draggedInfo.groupId);
            const targetGroup = db.groups.find(g => g.id === targetGroupId);
            const [member] = sourceGroup.members.splice(draggedInfo.memberIdx, 1);
            targetGroup.members.push(member);
            saveDB(); renderManageUI(); renderMonitoring(); // å› ç‚ºç¾¤çµ„åè®Šäº†ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“å¡ç‰‡
        }

        function toggleGroupCheckboxes(btn) {
            const cbs = btn.closest('.bg-slate-50').querySelectorAll('.char-cb');
            const allChecked = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !allChecked);
        }
        function toggleAllCheckboxes() {
            const cbs = document.querySelectorAll('.char-cb');
            const allChecked = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !allChecked);
        }
        function removeMonitor(idx) { monitors.splice(idx, 1); saveActive(); renderMonitoring(); }
        function clearAllMonitoring() { if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç›£æ¸¬æ™‚é˜ï¼Ÿ")) { monitors = []; saveActive(); renderMonitoring(); } }
        function saveDB() { localStorage.setItem('stamina_v6_db', JSON.stringify(db)); }
        function saveActive() { localStorage.setItem('stamina_v6_active', JSON.stringify(monitors)); }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
        function removeGroup(gi) { db.groups.splice(gi, 1); saveDB(); renderManageUI(); renderMonitoring(); }
        function removeMember(gid, mi) { 
            const g = db.groups.find(g => g.id === gid);
            const mid = g.members[mi].id;
            g.members.splice(mi, 1);
            monitors = monitors.filter(m => m.charId !== mid);
            saveDB(); saveActive(); renderManageUI(); renderMonitoring();
        }
    </script>
</body>
</html>
