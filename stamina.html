<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&family=Varela+Round&display=swap" rel="stylesheet">
    <title>é«”åŠ›ç›£æ§ä¸­å¿ƒ</title>
    <style>
        :root {
            /* é…è‰²å®šç¾© */
            --highlight-pink: #FF9D6F; 
            --full-green: #02C874;     
            --morandi-bg: #FBFBF9;
            --tag-bg: #F0EFEB;
        }

        body { 
            /* ä½¿ç”¨ Noto Sans TC ä¸¦æ¨¡æ“¬åœ“æ½¤æ„Ÿ */
            font-family: 'Varela Round', 'Noto Sans TC', "Microsoft JhengHei", sans-serif;
            background-color: #EAE8E4; 
            color: #6D6875;
        }
        
        /* å¡ç‰‡æ¨£å¼å›æº¯èˆ‡èª¿æ•´ */
        .card-standard { background-color: var(--morandi-bg); border: 1px solid #D7D3CC; }
        
        /* ä¿®æ­£ 6ï¼šå·²å›æ»¿å¤–æ¡†æ”¹ç‚º å¯¦ç·šã€åŠ ç²—ã€é¡è‰²åŒå­—é«”è‰² (#02C874) */
        .card-full-highlight { 
            background-color: var(--morandi-bg) !important; 
            border: 4px solid var(--full-green) !important; 
            box-shadow: 0 4px 15px rgba(2, 200, 116, 0.15);
        }
        
        /* æ–‡å­—é…è‰² */
        .text-status-pink { color: var(--highlight-pink); } 
        .text-full-green { color: var(--full-green); }

        /* ä¿®æ­£ 7ï¼šæ ¸å–æ–¹å¡Šæ¨£å¼å„ªåŒ–ï¼Œæ¸›è¼•åº•è‰² */
        .char-cb { 
            accent-color: #8E9AAF;
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }

        /* ä¿®æ­£ 8ï¼šæ¨™ç±¤æ–‡å­—å°æ¯”åº¦å¼·åŒ– */
        .tag-label {
            background-color: var(--tag-bg);
            color: #5E548E; /* åŠ æ·±æ¨™ç±¤å­—é«”é¡è‰² */
            border: 1px solid #D7D3CC;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900;
        }

        .progress-ring-circle { transition: stroke-dashoffset 0.8s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }

        /* åœ“æ½¤æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† */
        button, select, input { border-radius: 1rem !important; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col lg:flex-row justify-between items-center mb-10 bg-[#FBFBF9] p-8 rounded-[2rem] shadow-sm border border-[#D7D3CC] gap-6">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-[#6D6875] rounded-2xl flex items-center justify-center text-[#F4F2EE] text-3xl font-black">âš¡</div>
                <div>
                    <h2 class="text-3xl font-black text-[#5E548E] tracking-tight">é«”åŠ›ç›£æ§ä¸­å¿ƒ</h2>
                    <p class="text-xs font-bold text-[#8E9AAF] tracking-widest">REAL-TIME MONITOR</p>
                </div>
            </div>
            
            <div class="flex gap-3 flex-wrap justify-center items-center">
                <button onclick="location.href='portal.html'" class="bg-[#6D6875] text-white px-6 py-4 rounded-2xl text-base font-black shadow-sm hover:opacity-90">è¿”å›å…¥å£</button>
                <button onclick="openManageModal()" class="bg-[#B8B0A5] text-white px-6 py-4 rounded-2xl text-base font-black shadow-sm hover:opacity-90">ğŸ‘¥ åå–®ç¾¤çµ„ç®¡ç†</button>
                <button onclick="clearAllMonitoring()" class="bg-[#AF7A7D] text-white px-6 py-4 rounded-2xl text-base font-black shadow-sm hover:opacity-90">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º</button>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <div class="xl:col-span-1">
                <div class="bg-[#FBFBF9] p-8 rounded-[2.5rem] shadow-sm border border-[#D7D3CC]">
                    <h3 class="text-lg font-black text-[#6D6875] mb-6 border-b border-[#E0DDD7] pb-4">ğŸ“… é¸æ“‡ç•¶å‰æ´»å‹•</h3>
                    <select id="activitySelect" class="w-full p-4 bg-white rounded-2xl font-black text-lg text-[#8E9AAF] border border-[#D7D3CC] mb-4 outline-none"></select>
                    <div class="bg-[#F4F2EE] p-5 rounded-2xl space-y-2 text-sm font-bold">
                        <p>å›é«”é€Ÿç‡ï¼š<span id="rateDetail" class="text-[#8E9AAF]">--</span></p>
                        <p>é«”åŠ›ä¸Šé™ï¼š<span id="maxDetail" class="text-[#8E9AAF]">--</span></p>
                    </div>
                    <button onclick="openBatchModal()" class="w-full mt-8 bg-[#8E9AAF] text-white py-5 rounded-[2rem] text-lg font-black shadow-md hover:brightness-95 transition-all">ğŸš€ æ‰¹é‡å•Ÿå‹•ç›£æ¸¬</button>
                </div>
            </div>

            <div class="xl:col-span-3">
                <div class="flex justify-between items-center mb-6 px-4">
                    <div class="flex items-center bg-[#F0EFEB] rounded-2xl p-1 border border-[#D7D3CC]">
                        <button onclick="changeSort(-1)" class="p-2 hover:bg-white rounded-xl transition text-[#8E9AAF] font-bold">â®</button>
                        <span id="sortModeText" class="px-4 font-black text-sm text-[#6D6875]">æŒ‰æ´»å‹• (é è¨­)</span>
                        <button onclick="changeSort(1)" class="p-2 hover:bg-white rounded-xl transition text-[#8E9AAF] font-bold">â¯</button>
                    </div>
                </div>
                <div id="monitorGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                <div id="emptyDisplay" class="hidden text-center py-40 bg-[#FBFBF9] rounded-[3rem] border-4 border-dashed border-[#D7D3CC]">
                    <p class="text-[#D7D3CC] font-black text-2xl">ç›®å‰å°šç„¡é€²è¡Œä¸­çš„ç›£æ¸¬</p>
                </div>
            </div>
        </div>
    </div>

    <div id="batchModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="closeModal('batchModal')" class="absolute top-10 right-10 text-[#D7D3CC] hover:text-[#6D6875] text-3xl font-black">âœ•</button>
            <h3 class="text-2xl font-black mb-2">æ‰¹é‡åŠ å…¥ç›£æ¸¬</h3>
            <div class="flex justify-between items-center mb-6 border-b border-[#D7D3CC] pb-4">
                <p id="currentActName" class="text-base font-bold text-[#FF9D6F]"></p>
                <button onclick="toggleAllCheckboxes()" id="btnSelectAll" class="bg-white border border-[#D7D3CC] px-4 py-2 rounded-xl font-black text-xs">å‹¾é¸æ‰€æœ‰äººç‰©</button>
            </div>
            <div id="batchInputList" class="overflow-y-auto flex-1 space-y-6 pr-2 mb-8"></div>
            <button onclick="submitBatch()" class="w-full bg-[#8E9AAF] text-white py-6 rounded-[2rem] text-xl font-black shadow-lg">ç¢ºèªä¸¦åŒæ­¥é«”åŠ›æ•¸æ“š</button>
        </div>
    </div>

    <div id="manageModal" class="fixed inset-0 bg-[#6D6875]/90 hidden items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="bg-[#FBFBF9] w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="closeModal('manageModal')" class="absolute top-10 right-10 text-[#D7D3CC] hover:text-[#6D6875] text-3xl font-black">âœ•</button>
            <h3 class="text-2xl font-black mb-6">åå–®èˆ‡ç¾¤çµ„ç®¡ç†</h3>
            <div class="flex gap-3 mb-8">
                <input id="newGroupName" type="text" placeholder="è¼¸å…¥æ–°ç¾¤çµ„åç¨±..." class="flex-1 bg-white border border-[#D7D3CC] p-4 rounded-2xl outline-none font-bold">
                <button onclick="addGroup()" class="bg-[#8E9AAF] text-white px-8 rounded-2xl font-black shadow-sm">å»ºç«‹ç¾¤çµ„</button>
            </div>
            <div id="groupListArea" class="overflow-y-auto flex-1 space-y-6 pr-2"></div>
        </div>
    </div>

    <script>
        let activities = [];
        let db = JSON.parse(localStorage.getItem('stamina_v13_db')) || { groups: [{ id: 'default', name: 'æœªåˆ†é¡äººç‰©', members: [] }] };
        let monitors = JSON.parse(localStorage.getItem('stamina_v13_active')) || [];
        let sortMode = 0; 
        const sortTexts = ["æŒ‰æ´»å‹• (é è¨­)", "æŒ‰å›æ»¿æ™‚é•·", "æŒ‰ç¾¤çµ„åç¨±", "æŒ‰äººç‰©åç¨±"];

        window.onload = function() {
            const data = JSON.parse(sessionStorage.getItem('gameData'));
            if(!data) return location.href = "index.html";
            activities = data.activities;

            const select = document.getElementById('activitySelect');
            activities.forEach((act, idx) => {
                const opt = document.createElement('option'); opt.value = idx; opt.textContent = act.name;
                select.appendChild(opt);
            });
            select.onchange = () => {
                const act = activities[select.value];
                document.getElementById('rateDetail').innerText = `${act.minPerStamina} åˆ†é˜ / 1 é»`;
                document.getElementById('maxDetail').innerText = `${act.maxStamina} é»`;
            };
            select.dispatchEvent(new Event('change'));
            renderMonitoring();
            setInterval(renderMonitoring, 1000);
        };

        function changeSort(dir) {
            sortMode = (sortMode + dir + 4) % 4;
            document.getElementById('sortModeText').innerText = sortTexts[sortMode];
            renderMonitoring();
        }

        // --- ä¿®æ­£ 5 & 9ï¼šå¡ç‰‡çµæ§‹å›æº¯ + å¯¦æ™‚é«”åŠ›æ¨™è¨» ---
        function renderMonitoring() {
            const grid = document.getElementById('monitorGrid');
            if(monitors.length === 0) { 
                grid.innerHTML = ""; document.getElementById('emptyDisplay').classList.remove('hidden'); return; 
            }
            document.getElementById('emptyDisplay').classList.add('hidden');

            const now = Date.now();
            let list = monitors.map((m, idx) => {
                const act = activities[m.actIdx];
                const mins = (now - m.startTime) / 60000;
                let current = Math.min(act.maxStamina, Math.max(0, m.initStamina + Math.floor(mins / act.minPerStamina)));
                const isFull = current >= act.maxStamina;
                let remSec = isFull ? 0 : ((act.maxStamina - current) * act.minPerStamina - (mins % act.minPerStamina)) * 60;
                return { ...m, current, isFull, remSec, actMax: act.maxStamina, actName: act.name, groupName: getGroupNameByCharId(m.charId), originalIdx: idx };
            });

            // æ’åºé‚è¼¯ (ç•¥...)
            if(sortMode === 1) list.sort((a,b)=>a.remSec - b.remSec);

            grid.innerHTML = list.map(m => {
                const percent = (m.current / m.actMax) * 100;
                const cardClass = m.isFull ? 'card-full-highlight' : 'card-standard';
                const textColor = m.isFull ? 'text-full-green' : 'text-status-pink';
                const ringColor = m.isFull ? '#02C874' : '#FF9D6F';
                
                let countdown = "å·²å……æ»¿";
                let fullTimeLabel = "ç‹€æ…‹ï¼šå·²å®Œå…¨å›æ»¿";
                
                if(!m.isFull) {
                    const h = Math.floor(m.remSec / 3600);
                    const min = Math.floor((m.remSec % 3600) / 60);
                    const sec = Math.floor(m.remSec % 60);
                    countdown = `${h}æ™‚ ${min}åˆ† ${sec}ç§’`;
                    const d = new Date(now + m.remSec * 1000);
                    fullTimeLabel = `å›æ»¿æ™‚é–“ï¼š${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                }

                return `
                <div class="${cardClass} p-8 rounded-[2.5rem] flex flex-col relative transition-all duration-300">
                    <button onclick="removeMonitor(${m.originalIdx})" class="absolute top-6 right-8 text-[#D7D3CC] hover:text-red-400 text-2xl z-10">âœ•</button>
                    
                    <div class="flex gap-2 mb-3">
                        <span class="tag-label">${m.actName}</span>
                        <span class="tag-label">${m.groupName}</span>
                    </div>

                    <div class="flex items-start justify-between mb-6">
                        <h4 class="text-2xl font-black text-[#6D6875] tracking-tight">${m.charName}</h4>
                        <div class="relative w-20 h-20 shrink-0">
                            <svg class="w-20 h-20"><circle class="text-[#F0EFEB]" stroke-width="8" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40"/>
                            <circle style="stroke: ${ringColor}" class="progress-ring-circle" stroke-width="8" stroke-dasharray="201" stroke-dashoffset="${201-(201*percent/100)}" stroke-linecap="round" fill="transparent" r="32" cx="40" cy="40"/></svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center font-black">
                                <span class="text-xl text-[#6D6875] leading-none">${m.current}</span>
                                <span class="text-[8px] text-[#A5A5A5] mt-1">ç›®å‰é«”åŠ›</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/40 p-5 rounded-[1.5rem] border border-[#D7D3CC]/30">
                        <p class="text-[10px] font-black text-[#A5A5A5] uppercase tracking-widest mb-1">å¯¦æ™‚é«”åŠ›ç‹€æ…‹</p>
                        <p class="text-3xl font-black ${textColor} tracking-tighter mb-2">${m.isFull ? 'é«”åŠ›å·²å›æ»¿' : countdown}</p>
                        <p class="text-xs font-bold text-[#8E9AAF]">${fullTimeLabel}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // --- æ‰¹é‡åŠ å…¥ (ä¿®æ­£ 4ï¼šå…¨é¸æ¨™ç±¤èˆ‡æŒ‰éˆ•é‚è¼¯) ---
        function toggleGroupCheckboxes(btn) {
            const wrapper = btn.closest('.group-wrapper');
            const cbs = wrapper.querySelectorAll('.char-cb');
            const allChecked = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !allChecked);
            btn.innerText = allChecked ? "æœ¬çµ„å…¨é¸" : "å–æ¶ˆå…¨é¸";
        }

        function toggleAllCheckboxes() {
            const cbs = document.querySelectorAll('.char-cb');
            const btn = document.getElementById('btnSelectAll');
            const anyUnchecked = Array.from(cbs).some(c => !c.checked);
            cbs.forEach(c => c.checked = anyUnchecked);
            btn.innerText = anyUnchecked ? "å–æ¶ˆæ‰€æœ‰å‹¾é¸" : "å‹¾é¸æ‰€æœ‰äººç‰©";
        }

        function openBatchModal() {
            const actIdx = document.getElementById('activitySelect').value;
            const act = activities[actIdx];
            document.getElementById('currentActName').innerText = "ç•¶å‰ç›£æ¸¬é …ç›®ï¼š" + act.name;
            const list = document.getElementById('batchInputList');
            list.innerHTML = db.groups.map(g => `
                <div class="bg-[#F4F2EE] p-5 rounded-[2rem] group-wrapper">
                    <div class="flex justify-between mb-4 items-center">
                        <span class="font-black text-[#8E9AAF] text-sm">ç¾¤çµ„ï¼š${g.name}</span>
                        <button onclick="toggleGroupCheckboxes(this)" class="text-xs text-[#8E9AAF] border border-[#D7D3CC] px-2 py-1 rounded-lg font-black bg-white">æœ¬çµ„å…¨é¸</button>
                    </div>
                    <div class="space-y-3">
                        ${g.members.map(m => `
                            <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-[#D7D3CC]">
                                <input type="checkbox" class="char-cb" data-name="${m.name}" data-id="${m.id}">
                                <span class="flex-1 font-black text-[#6D6875]">${m.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold text-[#A5A5A5]">èµ·å§‹é«”åŠ›</span>
                                    <input type="number" class="stamina-input w-20 p-2 bg-[#F4F2EE] rounded-lg text-center font-black" 
                                           value="0" min="0" max="${act.maxStamina}" oninput="this.value = Math.max(0, Math.min(${act.maxStamina}, this.value))">
                                </div>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
            document.getElementById('batchModal').classList.replace('hidden', 'flex');
        }

        function submitBatch() {
            const actIdx = document.getElementById('activitySelect').value;
            const act = activities[actIdx];
            const rows = document.querySelectorAll('#batchInputList input[type="checkbox"]:checked');
            if(rows.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½äººç‰©");
            
            rows.forEach(cb => {
                const row = cb.closest('.bg-white');
                const val = parseInt(row.querySelector('.stamina-input').value) || 0;
                const existingIdx = monitors.findIndex(m => m.charId === cb.dataset.id && m.actIdx == actIdx);
                const data = { charId: cb.dataset.id, charName: cb.dataset.name, actIdx: actIdx, initStamina: val, startTime: Date.now() };
                if(existingIdx > -1) monitors[existingIdx] = data; else monitors.push(data);
            });
            saveActive(); closeModal('batchModal'); renderMonitoring();
        }

        // --- ä¿®æ­£ 3ï¼šåå–®ç®¡ç†èˆ‡åˆªé™¤æ‰€æœ‰æˆå“¡ ---
        function clearGroupMembers(gid) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤è©²ç¾¤çµ„å…§çš„æ‰€æœ‰æˆå“¡å—ï¼Ÿ")) {
                db.groups.find(g => g.id === gid).members = [];
                saveDB(); renderManageUI();
            }
        }

        function renderManageUI() {
            const area = document.getElementById('groupListArea');
            area.innerHTML = db.groups.map((g, gi) => `
                <div class="bg-[#F4F2EE] p-6 rounded-[2rem] border border-[#D7D3CC]">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xl font-black text-[#6D6875]">${g.name}</span>
                        <div class="flex gap-2">
                            <button onclick="clearGroupMembers('${g.id}')" class="text-xs text-[#AF7A7D] border border-[#AF7A7D] px-2 py-1 rounded-lg font-black">ğŸ—‘ï¸ æ¸…ç©ºæˆå“¡</button>
                            ${g.id !== 'default' ? `<button onclick="removeGroup(${gi})" class="text-xs text-white bg-[#AF7A7D] px-2 py-1 rounded-lg font-black">åˆªé™¤ç¾¤çµ„</button>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input type="text" placeholder="äººç‰©åç¨±" class="flex-1 p-2 rounded-xl text-sm border-none shadow-inner char-input">
                        <button onclick="addMemberInLine(this, '${g.id}')" class="bg-[#8E9AAF] text-white px-4 rounded-xl text-xs font-black">æ–°å¢</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3 min-h-[40px]">
                        ${g.members.map((m, mi) => `
                            <div class="bg-white p-3 rounded-xl text-sm font-black flex justify-between border border-[#D7D3CC]">
                                <span>${m.name}</span>
                                <button onclick="removeMember('${g.id}', ${mi})" class="text-[#D7D3CC] hover:text-red-400">âœ•</button>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
        }

        // --- åŸºç¤å‡½æ•¸ ---
        function addMemberInLine(btn, gid) { const inp = btn.previousElementSibling; if(!inp.value) return; db.groups.find(g=>g.id===gid).members.push({name:inp.value, id:'c'+Date.now()}); inp.value=""; saveDB(); renderManageUI(); }
        function addGroup() { const n = document.getElementById('newGroupName').value; if(n){ db.groups.push({id:'g'+Date.now(), name:n, members:[]}); document.getElementById('newGroupName').value=""; saveDB(); renderManageUI(); }}
        function removeGroup(gi) { if(confirm("ç¢ºå®šåˆªé™¤ç¾¤çµ„ï¼Ÿ")) { db.groups.splice(gi,1); saveDB(); renderManageUI(); }}
        function removeMember(gid, mi) { const g = db.groups.find(g=>g.id===gid); g.members.splice(mi,1); saveDB(); renderManageUI(); }
        function saveDB() { localStorage.setItem('stamina_v13_db', JSON.stringify(db)); }
        function saveActive() { localStorage.setItem('stamina_v13_active', JSON.stringify(monitors)); }
        function removeMonitor(idx) { monitors.splice(idx,1); saveActive(); renderMonitoring(); }
        function clearAllMonitoring() { if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç›£æ¸¬ï¼Ÿ")) { monitors=[]; saveActive(); renderMonitoring(); }}
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
        function openManageModal() { renderManageUI(); document.getElementById('manageModal').classList.replace('hidden', 'flex'); }
        function getGroupNameByCharId(id) { for (let g of db.groups) { if (g.members.some(m => m.id === id)) return g.name; } return "æœªåˆ†é¡"; }
    </script>
</body>
</html>
